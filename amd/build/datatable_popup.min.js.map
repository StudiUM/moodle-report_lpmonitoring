{"version":3,"sources":["../src/datatable_popup.js"],"names":["define","$","notification","str","ajax","templates","ModalFactory","ModalEvents","DatatablePopup","regionSelector","userCompetencySelector","on","_handleClick","bind","prototype","focusContentItem","item","is","focus","find","first","e","preventDefault","cell","target","competencyId","data","elementId","userId","type","requests","call","methodname","args","userid","competencyid","cmid","courseid","when","apply","then","context","_contextLoaded","catch","exception","trigger","self","displayuser","usercompetencysummary","cangrade","templatepath","coursemodule","get_string","done","title","create","types","DEFAULT","body","render","large","modal","getRoot","hidden","destroy","show","fail"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Popup to view detail of competency for a user, for a course or course module.\n *\n * @module     report_lpmonitoring/datatable_popup\n * @author     Marie-Eve Lévesque <marie-eve.levesque.8@umontreal.ca>\n * @copyright  2019 Université de Montréal\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or laterer\n */\n\ndefine(['jquery', 'core/notification', 'core/str', 'core/ajax', 'core/templates',\n        'core/modal_factory',\n        'core/modal_events'],\n        function($, notification, str, ajax, templates, ModalFactory, ModalEvents) {\n\n            /**\n             * DatatablePopup\n             *\n             * @param {String} regionSelector The regionSelector\n             * @param {String} userCompetencySelector The userCompetencySelector\n             */\n            var DatatablePopup = function(regionSelector, userCompetencySelector) {\n                $(regionSelector).on('click', userCompetencySelector, this._handleClick.bind(this));\n            };\n\n            /**\n             * Focus the given content item or the first focusable element within\n             * the content item.\n             *\n             * @method focusContentItem\n             * @param {object} item The content item jQuery element\n             */\n            DatatablePopup.prototype.focusContentItem = function(item) {\n                var focusable = 'input:not([type=\"hidden\"]), a[href], button, textarea, select, [tabindex]';\n                if (item.is(focusable)) {\n                    item.focus();\n                } else {\n                    item.find(focusable).first().focus();\n                }\n            };\n\n            /**\n             * Get the data from the clicked cell and open the popup.\n             *\n             * @method _handleClick\n             * @param {Event} e The event\n             */\n            DatatablePopup.prototype._handleClick = function(e) {\n                // Do not scroll to top.\n                e.preventDefault();\n\n                var cell = $(e.target);\n                var competencyId = $(cell).data('competencyid');\n                var elementId = $(cell).data('elementid');\n                var userId = $(cell).data('userid');\n                var type = $(cell).data('type');\n\n                if (type == 'cm') {\n                    var requests = ajax.call([{\n                        methodname: 'tool_cmcompetency_data_for_user_competency_summary_in_coursemodule',\n                        args: {userid: userId, competencyid: competencyId, cmid: elementId},\n                    }, {\n                        methodname: 'tool_cmcompetency_user_competency_viewed_in_coursemodule',\n                        args: {userid: userId, competencyid: competencyId, cmid: elementId},\n                    }]);\n                } else {\n                    var requests = ajax.call([{\n                        methodname: 'report_lpmonitoring_data_for_user_competency_summary_in_course',\n                        args: {userid: userId, competencyid: competencyId, courseid: elementId},\n                    }, {\n                        methodname: 'report_lpmonitoring_user_competency_viewed_in_course',\n                        args: {userid: userId, competencyid: competencyId, courseid: elementId},\n                    }]);\n                }\n\n                $.when.apply($, requests).then(function(context) {\n                    this._contextLoaded.bind(this)(context, cell);\n                    return;\n                }.bind(this)).catch(notification.exception);\n            };\n\n            /**\n             * We loaded the context, now render the template.\n             *\n             * @method _contextLoaded\n             * @param {Object} context\n             * @param {Object} trigger\n             */\n            DatatablePopup.prototype._contextLoaded = function(context, trigger) {\n                var self = this;\n                // We have to display user info in popup.\n                context.displayuser = true;\n                // Impossible to grade course directly in this popup.\n                context.usercompetencysummary.cangrade = false;\n\n                var templatepath = 'tool_lp/user_competency_summary_in_course';\n                if (typeof context.coursemodule !== 'undefined') {\n                    templatepath = 'report_cmcompetency/user_competency_summary_in_coursemodule';\n                }\n\n                return str.get_string('usercompetencysummary', 'report_competency').done(function(title) {\n                    return ModalFactory.create({\n                        type: ModalFactory.types.DEFAULT,\n                        title: title,\n                        body: templates.render(templatepath, context),\n                        large: true\n                    }, trigger).done(function(modal) {\n                        modal.getRoot().on(ModalEvents.hidden, function() {\n                            self.focusContentItem(trigger);\n                            modal.destroy();\n                        });\n                        modal.show();\n                    }.bind(this));\n                }).fail(notification.exception);\n            };\n\n            return DatatablePopup;\n\n        });\n"],"file":"datatable_popup.min.js"}