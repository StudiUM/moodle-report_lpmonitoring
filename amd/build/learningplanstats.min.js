define(["jquery","core/templates","core/ajax","core/notification","core/str","report_lpmonitoring/Chart","core/form-autocomplete","report_lpmonitoring/fieldsettoggler","report_lpmonitoring/colorcontrast","tool_lp/dialogue","report_lpmonitoring/paginated_datatable"],function(a,b,c,d,e,f,g,h,i,j,k){var l=function(){this.initPage(),this.colorContrast=i.init(),a(this.templateSelector).on("change",this.templateChangeHandler.bind(this)).change()};return l.prototype.templateSelector="#templateSelectorStats",l.prototype.templateId=null,l.prototype.competencies={},l.prototype.colorcontrast=null,l.prototype.templateChangeHandler=function(b){var c=this;c.templateId=a(b.target).val(),c.templateId?a("#submitFilterStatstButton").removeAttr("disabled"):a("#submitFilterStatstButton").attr("disabled","disabled")},l.prototype.submitFormHandler=function(){var a=this;a.templateId&&a.loadListCompetencies(a.templateId)},l.prototype.loadListCompetencies=function(e){var f=this,g=!0;a("#ratinginplanoption").is(":checked")&&(g=!1);var h=c.call([{methodname:"core_competency_list_competencies_in_template",args:{id:e}}]),i=a("#submitFilterStatstButton");i.addClass("loading"),h[0].then(function(c){if(c.length>0){var d={competencies_list:c};return b.render("report_lpmonitoring/list_competencies_stats",d).done(function(d,h){a("#list-competencies-template").html(d),b.runTemplateJS(h),i.removeClass("loading"),f.loadCompetencyDetail(c,e,g)})}return i.removeClass("loading"),b.render("report_lpmonitoring/list_competencies_stats",{}).done(function(c,d){a("#list-competencies-template").html(c),b.runTemplateJS(d)})}).fail(function(a){i.removeClass("loading"),d.exception(a)})},l.prototype.loadCompetencyDetail=function(e,g,h){var i=[],j=this,k="report_lpmonitoring_get_competency_statistics",l="report_lpmonitoring/competency_detail_stats";h&&(k="report_lpmonitoring_get_competency_statistics_incourse",l="report_lpmonitoring/competency_detail_stats_incourse"),a.each(e,function(a,b){j.competencies[b.id]={infocompetency:b},i.push({methodname:k,args:{competencyid:b.id,templateid:g}})}),a(".competencyreport .competency-detail").addClass("loading"),a.when.apply(a.when,c.call(i)).then(function(){a.each(arguments,function(c,d){var e=d.competencyid;j.competencies[e].competencydetail=d,b.render(l,d).done(function(c,g){a("#comp-"+e).removeClass("loading"),a("#comp-"+e+" .x_content").html(c);var i={legend:!1,responsive:!1,tooltips:{enabled:!1}},k=[],l=[],m=!1;h===!1&&0!==d.nbuserrated&&(a.each(d.scalecompetencyitems,function(a,b){k.push(b.color),l.push(b.nbusers)}),m=!0),h===!0&&0!==d.nbratings&&(a.each(d.scalecompetencyitems,function(a,b){k.push(b.color),l.push(b.nbratings)}),m=!0),m===!0&&new f(a("#canvas-graph-"+e),{type:"doughnut",data:{labels:[],datasets:[{data:l,backgroundColor:k,hoverBackgroundColor:[]}]},options:i}),b.runTemplateJS(g),j.colorContrast.apply("#comp-"+e+" .x_content .tile-stats .label.cr-scalename")})})}).fail(function(b){a("#list-competencies-template").empty(),d.exception(b)})},l.prototype.displayScaleUserList=function(a,c,f){var g=this;a.competencyid=c,a.scalevalue=f,a.scalecompetencyitem.listusers.length>0&&e.get_string("linkedusers","report_lpmonitoring").done(function(e){b.render("report_lpmonitoring/list_users_in_scale_value",a).done(function(a,d){new j(e,a,function(){k.apply("#list-user-"+c+"-"+f)},g.destroyDialogue),b.runTemplateJS(d),g.colorContrast.apply(".moodle-dialogue-base .label.cr-scalename")}).fail(d.exception)})},l.prototype.displayTotalUserList=function(a){var c=this;a.totaluserlist.length>0&&e.get_string("userlist").done(function(e){b.render("report_lpmonitoring/list_users_in_competency_stats",a).done(function(d,f){new j(e,d,function(){k.apply("#list-users-stats-"+a.competencyid)},c.destroyDialogue),b.runTemplateJS(f)}).fail(d.exception)})},l.prototype.destroyDialogue=function(a){a.close()},l.prototype.initPage=function(){var b=this;e.get_strings([{key:"selectlearningplantemplate",component:"report_lpmonitoring"},{key:"notemplateselected",component:"report_lpmonitoring"}]).done(function(a){g.enhance(b.templateSelector,!1,"report_lpmonitoring/learningplanstats",a[0],!1,!0,a[1])}).fail(d.exception),h.init(),a(document).on("submit","#statstFilter",function(){return b.submitFormHandler(),!1}),a(".competencyreport").on("click","a.scaleinfo",function(){var c=a(this).data("competencyid"),d=a(this).data("scalevalue");if("undefined"!=typeof b.competencies[c]){var e={},f=b.competencies[c].competencydetail;e.scalecompetencyitem=f.scalecompetencyitems[d-1],b.displayScaleUserList(e,c,d)}}),a(".competencyreport").on("click","a.totalnbusers",function(c){c.preventDefault();var d=a(this).data("competencyid");if("undefined"!=typeof b.competencies[d]){var e={};e.totaluserlist=b.competencies[d].competencydetail.totaluserlist,e.competencyid=d,b.displayTotalUserList(e)}})},{init:function(){return new l},processResults:function(b,c){var d=[];return a.each(c,function(a,b){d.push({value:b.id,label:b._label})}),d},transport:function(d,e,f,g){var h,i=a(d).data("contextid");return""===i?[]:(h=c.call([{methodname:"report_lpmonitoring_search_templates",args:{query:e,contextid:parseInt(i)}}]),void h[0].then(function(c){var d=[],e=0;return a.each(c,function(a,c){d.push(b.render("report_lpmonitoring/form-template-selector-suggestion",c))}),a.when.apply(a.when,d).then(function(){var b=arguments;a.each(c,function(a,c){c._label=b[e],e++}),f(c)})},g))}}});