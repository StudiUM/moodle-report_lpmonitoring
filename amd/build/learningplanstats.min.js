define ("report_lpmonitoring/learningplanstats",["jquery","core/templates","core/ajax","core/notification","core/str","core/chartjs","core/form-autocomplete","report_lpmonitoring/fieldsettoggler","report_lpmonitoring/colorcontrast","core/modal_factory","core/modal_events","report_lpmonitoring/paginated_datatable"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m=function(){this.initPage();this.colorContrast=i.init();a(this.templateSelector).on("change",this.templateChangeHandler.bind(this)).change()};m.prototype.templateSelector="#templateSelectorStats";m.prototype.templateId=null;m.prototype.competencies={};m.prototype.colorcontrast=null;m.prototype.templateChangeHandler=function(b){var c=this;c.templateId=a(b.target).val();if(c.templateId){a("#submitFilterStatstButton").removeAttr("disabled")}else{a("#submitFilterStatstButton").attr("disabled","disabled")}};m.prototype.submitFormHandler=function(){var a=this;if(a.templateId){a.loadListCompetencies(a.templateId)}};m.prototype.loadListCompetencies=function(e){var f=this,g="course";if(a("#ratinginplanoption").is(":checked")){g="plan"}else if(a("#ratingincoursemoduleoption").is(":checked")){g="coursemodule"}var h=c.call([{methodname:"core_competency_list_competencies_in_template",args:{id:e}}]),i=a("#submitFilterStatstButton");i.addClass("loading");h[0].then(function(c){if(0<c.length){return b.render("report_lpmonitoring/list_competencies_stats",{competencies_list:c}).done(function(d,h){a("#list-competencies-template").html(d);b.runTemplateJS(h);i.removeClass("loading");f.loadCompetenciesDetails(c,e,g)})}else{i.removeClass("loading");return b.render("report_lpmonitoring/list_competencies_stats",{}).done(function(c,d){a("#list-competencies-template").html(c);b.runTemplateJS(d)})}}).fail(function(a){i.removeClass("loading");d.exception(a)})};m.prototype.getCompetencyDetailDeferred=function(e,g,h){var i=this;return function(){var j=a.Deferred(),k=c.call(e);k[0].done(function(c){var d=c.competencyid;i.competencies[d].competencydetail=c;b.render(g,c).done(function(e,g){a("#comp-"+d).removeClass("loading");a("#comp-"+d+" .x_content").html(e);var j=[],k=[],l=!1;if("plan"===h&&0!==c.nbuserrated){a.each(c.scalecompetencyitems,function(a,b){j.push(b.color);k.push(b.nbusers)});l=!0}if(("course"===h||"coursemodule"===h)&&0!==c.nbratings){a.each(c.scalecompetencyitems,function(a,b){j.push(b.color);k.push(b.nbratings)});l=!0}if(!0===l){new f(a("#canvas-graph-"+d),{type:"doughnut",data:{labels:[],datasets:[{data:k,backgroundColor:j,hoverBackgroundColor:[]}]},options:{legend:!1,responsive:!1,tooltips:{enabled:!1}}})}b.runTemplateJS(g);i.colorContrast.apply("#comp-"+d+" .x_content .tile-stats .badge.cr-scalename")});j.resolve()}).fail(function(b){a("#list-competencies-template").empty();d.exception(b)});return j.promise()}};m.prototype.loadCompetenciesDetails=function(b,c,d){var e=this,f="report_lpmonitoring_get_competency_statistics",g="report_lpmonitoring/competency_detail_stats";if("course"==d){f="report_lpmonitoring_get_competency_statistics_incourse";g="report_lpmonitoring/competency_detail_stats_incourse"}else if("coursemodule"==d){f="report_lpmonitoring_get_competency_statistics_incoursemodules";g="report_lpmonitoring/competency_detail_stats_incourse"}var h=a.when({});a(".competencyreport .competency-detail").addClass("loading");a.each(b,function(a,b){e.competencies[b.id]={infocompetency:b};var i=[{methodname:f,args:{competencyid:b.id,templateid:c}}];h=h.then(e.getCompetencyDetailDeferred(i,g,d))})};m.prototype.displayScaleUserList=function(a,c,f,g){var h=this;a.competencyid=c;a.scalevalue=f;if(0<a.scalecompetencyitem.listusers.length){e.get_string("linkedusers","report_lpmonitoring").done(function(d){j.create({type:j.types.DEFAULT,title:d,body:b.render("report_lpmonitoring/list_users_in_scale_value",a),large:!0}).done(function(a){a.getRoot().on(k.hidden,function(){a.destroy();h.focusContentItem(g)}.bind(this));a.getRoot().on(k.bodyRendered,function(){l.apply("#list-user-"+c+"-"+f,!0,!0);h.colorContrast.apply(".moodle-dialogue-base .badge.cr-scalename")}.bind(this));a.show()}.bind(this))}).fail(d.exception)}};m.prototype.displayTotalUserList=function(a,c){var f=this;if(0<a.totaluserlist.length){e.get_string("userlist").done(function(d){j.create({type:j.types.DEFAULT,title:d,body:b.render("report_lpmonitoring/list_users_in_competency_stats",a),large:!0}).done(function(b){b.getRoot().on(k.hidden,function(){b.destroy();f.focusContentItem(c)}.bind(this));b.getRoot().on(k.bodyRendered,function(){l.apply("#list-users-stats-"+a.competencyid,!0,!0);f.colorContrast.apply(".moodle-dialogue-base .badge.cr-scalename")}.bind(this));b.show()}.bind(this))}).fail(d.exception)}};m.prototype.focusContentItem=function(a){if(a.is("input:not([type=\"hidden\"]), a[href], button, textarea, select, [tabindex]")){a.focus()}else{a.find("input:not([type=\"hidden\"]), a[href], button, textarea, select, [tabindex]").first().focus()}};m.prototype.initPage=function(){var b=this;e.get_strings([{key:"selectlearningplantemplate",component:"report_lpmonitoring"},{key:"notemplateselected",component:"report_lpmonitoring"}]).done(function(a){g.enhance(b.templateSelector,!1,"report_lpmonitoring/learningplanstats",a[0],!1,!0,a[1])}).fail(d.exception);h.init();a(document).on("submit","#statstFilter",function(){b.submitFormHandler();return!1});a(".competencyreport").on("click","a.scaleinfo",function(c){c.preventDefault();var d=a(c.target).closest("td"),e=a(this).data("competencyid"),f=a(this).data("scalevalue");if("undefined"!=typeof b.competencies[e]){var g={},h=b.competencies[e].competencydetail;g.scalecompetencyitem=h.scalecompetencyitems[f-1];b.displayScaleUserList(g,e,f,d)}});a(".competencyreport").on("click","a.totalnbusers",function(c){c.preventDefault();var d=a(this).data("competencyid"),e=a(c.target);if("undefined"!=typeof b.competencies[d]){var f={totaluserlist:b.competencies[d].competencydetail.totaluserlist,competencyid:d};b.displayTotalUserList(f,e)}})};return{init:function init(){return new m},processResults:function processResults(b,c){var d=[];a.each(c,function(a,b){d.push({value:b.id,label:b._label})});return d},transport:function transport(d,e,f,g){var h,i=a(d).data("contextid");if(""===i){return[]}h=c.call([{methodname:"report_lpmonitoring_search_templates",args:{query:e,contextid:parseInt(i)}}]);h[0].then(function(c){var d=[],e=0;a.each(c,function(a,c){d.push(b.render("report_lpmonitoring/form-template-selector-suggestion",c))});return a.when.apply(a.when,d).then(function(){var b=arguments;a.each(c,function(a,c){c._label=b[e];e++});f(c)})},g)}}});
//# sourceMappingURL=learningplanstats.min.js.map
