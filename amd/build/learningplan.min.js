define ("report_lpmonitoring/learningplan",["jquery","core/templates","core/ajax","core/notification","core/str","core/chartjs","core/form-autocomplete","core/modal_factory","core/modal_events","report_lpmonitoring/user_competency_popup","tool_lp/grade_user_competency_inline","report_lpmonitoring/fieldsettoggler","report_lpmonitoring/colorcontrast","report_lpmonitoring/paginated_datatable","report_lpmonitoring/resetgrade_dialogue"],function(o,e,t,n,a,l,r,c,p,i,s,d,m,g,y){var h=function(e,t){this.userView=e||!1;this.cmcompgradingEnabled=t||!1;this.initPage();this.colorContrast=m.init();var n=this,a=new i("[data-region=list-competencies-section]","[data-user-competency=true]");a._refresh=function(){var e=this;n.reloadCompetencyDetail(e._competencyId,e._userId,e._planId);e.close()};o(this.templateSelector).on("change",this.templateChangeHandler.bind(this)).change();o(this.learningplanSelector).on("change",this.learningplanChangeHandler.bind(this)).change();o(this.studentSelector).on("change",this.studentChangeHandler.bind(this)).change();o(this.studentPlansSelector).on("change",this.studentPlansChangeHandler.bind(this)).change();o(this.tagSelector).on("change",this.tagChangeHandler.bind(this)).change();o(this.learningplanTagSelector).on("change",this.learningplanTagChangeHandler.bind(this)).change();o(this.learningplanTagCommentsSelector).on("change",this.learningplanTagChangeHandler.bind(this)).change();o(".competencyreport").on("change",".scalefiltercontainer input[name=\"optionscalefilter\"]",this.changeScaleApplyHandler.bind(this)).change();o(".competencyreport").on("change",".scalesortordercontainer input[name=\"optionscalesortorder\"]",this.changeScaleSortorderHandler.bind(this)).change();o(".competencyreport").on("change",".scalefiltervalues",this.changeScaleHandler.bind(this)).change();o(".competencyreport input[name=optionfilter]").prop("disabled",!1);o(".competencyreport input[name=optionscalesortorder]").prop("disabled",!1);o(".competencyreport").on("change",".displayratings input[type=checkbox]",this.changeDisplayRating.bind(this)).change();o(".competencyreport").on("change","#filter-comment",this.changeWithcommentsHandler.bind(this)).change();o(".competencyreport").on("change","#filter-plan",this.changeWithplansHandler.bind(this)).change();o(".competencyreport").on("DOMSubtreeModified",".tags-stats",this.reloadTagsIfNeeded.bind(this));o(".competencyreport").on("change","#filter-comments",this.reloadTagsIfNeeded.bind(this))};h.prototype.templateId=null;h.prototype.userView=!1;h.prototype.learningplanId=null;h.prototype.studentLearningplanId=null;h.prototype.tagLearningplanId=null;h.prototype.tagId=null;h.prototype.userId=null;h.prototype.templateSelected=null;h.prototype.studentSelected=null;h.prototype.competencies={};h.prototype.scalesvaluesSelected=null;h.prototype.colorcontrast=null;h.prototype.scalefilterin="";h.prototype.scalesortorder="ASC";h.prototype.withcomments=!1;h.prototype.withplans=!1;h.prototype.cmcompgradingEnabled=!1;h.prototype.templateSelector="#templateSelectorReport";h.prototype.learningplanSelector="#learningplanSelectorReport";h.prototype.studentSelector="#studentSelectorReport";h.prototype.studentPlansSelector="#studentPlansSelectorReport";h.prototype.tagSelector="#tagSelectorReport";h.prototype.learningplanTagSelector="#learningplanTagSelectorReport";h.prototype.learningplanTagCommentsSelector="#filter-comments";h.prototype.tagsAreLoading=!1;h.prototype.compDetailActiveTab=null;h.prototype.templateChangeHandler=function(t){var e=this;e.templateId=o(t.target).val();o(e.learningplanSelector).data("templateid",e.templateId);o(e.learningplanSelector).data("scalefilter","");o(e.learningplanSelector).data("scalesortorder","");e.resetUserUsingLPTemplateSelection();e.learningplanId=null;if(""!==e.templateId){o(".competencyreport .moreless-actions").removeClass("hidden");if(o(".competencyreport .show-toggler").hasClass("hidden")){o(".competencyreport .advanced").show()}e.loadScalesFromTemplate(e.templateId)}else{o(".competencyreport .moreless-actions").addClass("hidden");o(".competencyreport .advanced").hide();o(".competencyreport #scale").empty()}e.checkDataFormReady()};h.prototype.loadTags=function(){var e=this;if(!1===e.tagsAreLoading){e.tagsAreLoading=!0;o(e.tagSelector+" option").remove();var l=t.call([{methodname:"report_lpmonitoring_search_tags_for_accessible_plans",args:{}}]);l[0].then(function(t){a.get_string("selecttag","report_lpmonitoring").done(function(n){o(e.tagSelector).append(o("<option>").text(n).val(""));o.each(t,function(t,n){o(e.tagSelector).append(o("<option>").text(n.tag).val(n.id))});var a=0<o(e.tagSelector+" option[value="+e.tagId+"]").length;if(!0==a){o(e.tagSelector).val(e.tagId)}else{e.tagId=null;e.tagLearningplanId=null}o(e.tagSelector).change();e.tagsAreLoading=!1})}).fail(function(t){n.exception(t);e.tagsAreLoading=!1})}};h.prototype.reloadTagsIfNeeded=function(e){e.preventDefault();if(o(".competencyreport #tag").is(":checked")){this.loadTags()}};h.prototype.tagChangeHandler=function(l){var e=this;e.tagId=o(l.target).val();e.withcomments=o("#filter-comments").is(":checked");if(""==e.tagId){e.tagId=null}var r=t.call([{methodname:"report_lpmonitoring_search_plans_with_tag",args:{tagid:e.tagId,withcomments:e.withcomments}}]);r[0].then(function(t){var n="",l=e.tagLearningplanId;o(e.learningplanTagSelector+" option").remove();if(0<t.length){a.get_string("selectlearningplan","report_lpmonitoring").done(function(a){o(e.learningplanTagSelector).append(o("<option>").text(a).val(""));o.each(t,function(t,a){n=a.fullname+" - "+a.planname;o(e.learningplanTagSelector).append(o("<option>").text(n).val(a.planid))});o(e.learningplanTagSelector).prop("disabled",!1);var r=e.learningplanTagSelector+" option[value="+l+"]",c=0<o(r).length;if(!0===c){o(e.learningplanTagSelector).val(l);e.tagLearningplanId=l}else{e.tagLearningplanId=null}})}else{o(e.learningplanTagSelector).prop("disabled",!0);a.get_string("nolearningplanavailable","report_lpmonitoring").done(function(t){o(e.learningplanTagSelector).append(o("<option>").text(t).val(""))})}o(e.learningplanTagSelector).trigger("change")}).fail(function(e){n.exception(e)});e.checkDataFormReady()};h.prototype.learningplanTagChangeHandler=function(t){var e=this;e.tagLearningplanId=o(t.target).val();e.checkDataFormReady()};h.prototype.changeDisplayRating=function(a){var e=0;if(o(a.target).is(":checked")){e=1}var l=o(a.target).data("displayrating-plan"),r=t.call([{methodname:"tool_lp_set_display_rating_for_plan",args:{planid:l,visible:e}},{methodname:"tool_lp_can_reset_display_rating_for_plan",args:{planid:l}}]);r[0].then(function(){r[1].then(function(t){if(e){o(".competencyreport .displayratings input[type=checkbox]").prop("checked",!0)}else{o(".competencyreport .displayratings input[type=checkbox]").prop("checked",!1)}if(t){o(".competencyreport .resetdisplayrating").show()}}).fail(function(e){n.exception(e)})}).fail(function(e){n.exception(e)})};h.prototype.resetDisplayRating=function(e){var a=t.call([{methodname:"tool_lp_reset_display_rating_for_plan",args:{planid:e}},{methodname:"tool_lp_has_to_display_rating",args:{planid:e}}]);a[0].then(function(){a[1].then(function(e){if(e){o(".competencyreport .displayratings input[type=checkbox]").prop("checked",!0)}else{o(".competencyreport .displayratings input[type=checkbox]").prop("checked",!1)}o(".competencyreport .resetdisplayrating").hide()}).fail(function(e){n.exception(e)})}).fail(function(e){n.exception(e)})};h.prototype.resetUserUsingLPTemplateSelection=function(){var e=this,t=o(".competencyreport .templatefilter .form-autocomplete-selection"),n=t.find("span[aria-selected=\"true\"]");e.learningplanId=null;if(n.length){n.remove();o(e.learningplanSelector+" option").remove();a.get_string("nouserselected","report_lpmonitoring").done(function(e){t.append(o("<span>").text(e))})}};h.prototype.loadScalesFromTemplate=function(a){var l=this,r=t.call([{methodname:"report_lpmonitoring_get_scales_from_template",args:{templateid:parseInt(a)}}]);r[0].then(function(t){var n={scales:t,cmcompgradingenabled:l.cmcompgradingEnabled};e.render("report_lpmonitoring/scale_filter",n).done(function(t,n){o(".competencyreport #scale").html(t);e.runTemplateJS(n)});if(0<t.length){o(".competencyreport #scalefilterapply").show();e.render("report_lpmonitoring/scale_filter_apply",n).done(function(t,n){o(".competencyreport #scalefilter").html(t);e.runTemplateJS(n)});o(".competencyreport #scalesortorderlabel").show();e.render("report_lpmonitoring/scale_filter_sortorder",n).done(function(t,n){o(".competencyreport #scalesortorder").html(t);e.runTemplateJS(n)})}else{o(".competencyreport #scalefilterapply").hide();o(".competencyreport #scalesortorderlabel").hide();o(".competencyreport #scalefilter").html("");o(".competencyreport #scalesortorder").html("")}}).fail(function(e){n.exception(e)})};h.prototype.buildLearningplanOptions=function(e){var t=this;o(t.scaleSelector+" option").remove();o(t.scaleSelector).append(o("<option>"));o.each(e,function(e,n){o(t.scaleSelector).append(o("<option>").text(n.name).val(n.id))})};h.prototype.learningplanChangeHandler=function(t){var e=this;e.learningplanId=o(t.target).val();e.checkDataFormReady()};h.prototype.studentChangeHandler=function(l){var e=this;e.userId=o(l.target).val();if(null!==e.userId){var r=t.call([{methodname:"core_competency_list_user_plans",args:{userid:e.userId}}]);r[0].then(function(t){o(e.studentPlansSelector+" option").remove();if(0<t.length){o(e.studentPlansSelector).prop("disabled",!1);o.each(t,function(t,n){o(e.studentPlansSelector).append(o("<option>").text(n.name).val(n.id))})}else{o(e.studentPlansSelector).prop("disabled",!0);a.get_string("nolearningplanavailable","report_lpmonitoring").done(function(t){o(e.studentPlansSelector).append(o("<option>").text(t).val(""))})}o(e.studentPlansSelector).trigger("change")},n.exception)}e.checkDataFormReady()};h.prototype.studentPlansChangeHandler=function(t){var e=this;e.studentLearningplanId=o(t.target).val();e.checkDataFormReady()};h.prototype.checkDataFormReady=function(){var e=this,t=!1,n=!1,a=!1;if(!1===e.userView){t=o("#template").is(":checked")&&""!==o(e.templateSelector).val();n=o("#student").is(":checked")&&null!==o(e.studentSelector).val()&&o("option:selected",o(e.studentSelector)).attr("value")!==void 0&&null!==o("option:selected",o(e.studentPlansSelector)).attr("value")&&o("option:selected",o(e.studentPlansSelector)).attr("value")!==void 0&&""!==o("option:selected",o(e.studentPlansSelector)).attr("value");a=o("#tag").is(":checked")&&""!==o(e.tagSelector).val()}else{n=null!==o(e.studentPlansSelector).val()&&""!==o(e.studentPlansSelector).val()}if(t||n||a){o("#submitFilterReportButton").removeAttr("disabled")}else{o("#submitFilterReportButton").attr("disabled","disabled")}};h.prototype.loadListCompetencies=function(a,l){var r=this,c=t.call([{methodname:"report_lpmonitoring_list_plan_competencies",args:{id:a.id}}]);c[0].then(function(t){if(0<t.length){e.render("report_lpmonitoring/list_competencies",{competencies_list:t,plan:a,hascompetencies:!0}).done(function(n,c){o("#listPlanCompetencies").html(n);e.runTemplateJS(c);r.loadCompetencyDetail(t,a,l);o("#nav-tabs").removeClass("hidden")})}else{l.removeClass("loading");e.render("report_lpmonitoring/list_competencies",{}).done(function(t,n){o("#listPlanCompetencies").html(t);e.runTemplateJS(n);o("#report-content").empty();o("#summary-content").empty();o("#nav-tabs").addClass("hidden")})}r.loadSummaryTab(a);r.loadReportTab(a)}).fail(function(e){l.removeClass("loading");n.exception(e)})};h.prototype.loadCompetencyDetail=function(n,a,l){var r=[],c=this;o.each(n,function(e,t){c.competencies[t.competency.id]={usercompetency:t.usercompetency};r.push({methodname:"report_lpmonitoring_get_competency_detail",args:{competencyid:t.competency.id,userid:a.user.id,planid:a.id}})});var p=t.call(r);o.each(p,function(t,n){n.then(function(n){c.competencies[n.competencyid].competencydetail=n;n.plan=a;n.plan.userid=a.user.id;n.cmcompgradingenabled=c.cmcompgradingEnabled;e.render("report_lpmonitoring/competency_detail",n).done(function(p,i){var s=n.competencyid,d=a.user.id,m=a.id,g=n.scaleid;o("#comp-"+s+" .x_content").html(p);if("incoursemodule"===c.compDetailActiveTab){o(".detail-comp-tab a[href=\"#tab-incms-content-"+n.competencyid+"\"]").tab("show")}else{o(".detail-comp-tab a[href=\"#tab-incourses-content-"+n.competencyid+"\"]").tab("show")}if(n.cangrade){c.applyInlineGrader(s,d,m,g)}if(!1!==n.hasrating){c.ApplyDonutGraph(s,n,!1)}if(!1!==n.hasratingincms&&c.cmcompgradingEnabled){c.ApplyDonutGraph(s,n,!0)}if(t===r.length-1){l.removeClass("loading");o(".competencyreport .competency-detail a.collapse-link").css("visibility","")}e.runTemplateJS(i);c.colorContrast.apply("#comp-"+s+" .x_content .tile-stats .badge.cr-scalename")})})})};h.prototype.loadReportTab=function(a){var l=this,r=t.call([{methodname:"report_lpmonitoring_list_plan_competencies_report",args:{id:a.id}}]);r[0].then(function(t){if(0<t.competencies_list.length){var n={reportinfos:t,plan:a,hascompetencies:!0},r=o("input[type=radio][name=reportfilter]:checked").val();if("course"==r){n.filterchecked_course=!0}else if("module"==r){n.filterchecked_module=!0}else{n.filterchecked_both=!0}n.tablesearchvalue=o("#table-search-competency").val();n.tablesearchvaluecolumn=o("#table-search-columns").val();n.scalefilterreport=o("#scale-filter-report option:selected").val();e.render("report_lpmonitoring/datatable",n).done(function(t,n){o("#report-content").html(t);e.runTemplateJS(n);var a=new i("[data-region=report-competencies-section]","[data-user-competency=true]");a._refresh=function(){var e=this;l.reloadCompetencyDetail(e._competencyId,e._userId,e._planId);e.close()}})}else{var n={hascompetencies:!1};e.render("report_lpmonitoring/datatable",n).done(function(t,n){o("#report-content").html(t);e.runTemplateJS(n)})}}).fail(function(e){n.exception(e)})};h.prototype.loadSummaryTab=function(a){var l=this,r=t.call([{methodname:"report_lpmonitoring_list_plan_competencies_summary",args:{id:a.id}}]);r[0].then(function(t){if(0<t.scale_competency.length){var n={reportinfos:t,plan:a,hascompetencies:!0},r=o("input[type=radio][name=summaryfilter]:checked").val();if("course"==r){n.filterchecked_course=!0}else if("module"==r){n.filterchecked_module=!0}else{n.filterchecked_both=!0}for(var c=o("#scale-filter-summary").val(),p=0,s;p<n.reportinfos.scale_competency.length;p++){s=n.reportinfos.scale_competency[p].scaleid;n.reportinfos.scale_competency[p].scaleselected=!1;if(s==c){n.reportinfos.scale_competency[p].scaleselected=!0}var d=o("#summary-search-competency-"+s).val();n.reportinfos.scale_competency[p].tablesearchvalue=d}e.render("report_lpmonitoring/summary",n).done(function(t,n){o("#summary-content").html(t);e.runTemplateJS(n);var a=new i("[data-region=summary-competencies-section]","[data-user-competency=true]");a._refresh=function(){var e=this;l.reloadCompetencyDetail(e._competencyId,e._userId,e._planId);e.close()}})}else{var n={hascompetencies:!1};e.render("report_lpmonitoring/summary",n).done(function(t,n){o("#summary-content").html(t);e.runTemplateJS(n)})}}).fail(function(e){n.exception(e)})};h.prototype.applyInlineGrader=function(e,t,n,o){var l=this;a.get_string("chooserating","tool_lp").done(function(a){var r=new s("#rate_"+e,o,e,t,n,"",a);r.on("competencyupdated",function(){l.reloadCompetencyDetail(e,t,n)})})};h.prototype.reloadCompetencyDetail=function(n,a,l){var r=this;r.competencies[n]={};var c=t.call([{methodname:"core_competency_read_plan",args:{id:l}},{methodname:"report_lpmonitoring_get_competency_detail",args:{competencyid:n,userid:a,planid:l}},{methodname:"report_lpmonitoring_read_plan",args:{scalevalues:"",templateid:null,planid:l,scalefilterin:r.scalefilterin,tagid:null,withcomments:!1,withplans:!1}}]);c[0].then(function(t){c[1].then(function(n){r.competencies[n.competencyid].competencydetail=n;n.plan=t;n.cmcompgradingenabled=r.cmcompgradingEnabled;e.render("report_lpmonitoring/competency_detail",n).done(function(t,c){o("#comp-"+n.competencyid+" .x_content").html(t);e.runTemplateJS(c);if("incoursemodule"===r.compDetailActiveTab){o(".detail-comp-tab a[href=\"#tab-incms-content-"+n.competencyid+"\"]").tab("show")}else{o(".detail-comp-tab a[href=\"#tab-incourses-content-"+n.competencyid+"\"]").tab("show")}if(n.cangrade){r.applyInlineGrader(n.competencyid,a,l,n.scaleid)}if(!1!==n.hasrating){r.ApplyDonutGraph(n.competencyid,n,!1)}if(!1!==n.hasratingincm&&r.cmcompgradingEnabled){r.ApplyDonutGraph(n.competencyid,n,!0)}r.colorContrast.apply("#comp-"+n.competencyid+" .x_content .tile-stats .badge.cr-scalename")});e.render("report_lpmonitoring/competency_proficiency",n).done(function(t,a){o("#comp-"+n.competencyid+" span.level").html(t);e.runTemplateJS(a)});c[2].then(function(t){e.render("report_lpmonitoring/plan_stats_report",{plan:t.plan,hascompetencies:!0}).done(function(t,n){o("#plan-stats-report").html(t);e.runTemplateJS(n)})})})})};h.prototype.ApplyDonutGraph=function(e,t,n){var a=[],r="#canvas-graph-"+e;if(n){r="#cm-canvas-graph-"+e}var c=[];o.each(t.scalecompetencyitems,function(e,t){a.push(t.color);if(n){c.push(t.nbcm)}else{c.push(t.nbcourse)}});new l(o(r),{type:"doughnut",data:{labels:[],datasets:[{data:c,backgroundColor:a,hoverBackgroundColor:[]}]},options:{legend:!1,responsive:!1,tooltips:{enabled:!1}}})};h.prototype.submitFormHandler=function(){var e=this,t=o("#template").is(":checked"),n=o("#tag").is(":checked"),a=null,l=null,r=null;if(!0===t){a=e.templateId;l=e.learningplanId;e.withcomments=o("#filter-comment").is(":checked");e.withplans=o("#filter-plan").is(":checked")}else if(!0===n){r=e.tagId;l=e.tagLearningplanId}else{l=e.studentLearningplanId}e.scalesvaluesSelected=o(e.learningplanSelector).data("scalefilter");if("coursemodule"===e.scalefilterin){e.compDetailActiveTab="incoursemodule"}else{e.compDetailActiveTab="incourse"}e.displayPlan(l,a,r)};h.prototype.changeScaleHandler=function(){var e=this,t=[];o(".competencyreport .scalefiltervalues").each(function(){if(o(this).is(":checked")){t.push({scalevalue:o(this).data("scalevalue"),scaleid:o(this).data("scaleid")})}});if(0<t.length){o(".competencyreport input[name=optionscalefilter]").prop("disabled",!1);o(".competencyreport input[name=optionscalesortorder]").prop("disabled",!1);if(o("#scalefiltercourse").is(":not(:checked)")&&o("#scalefilterplan").is(":not(:checked)")){if(e.cmcompgradingEnabled){o("#scalefiltercoursemodule").prop("checked",!0)}else{o("#scalefiltercourse").prop("checked",!0)}}if(o("#scalesortorderasc").is(":not(:checked)")&&o("#scalesortorderdesc").is(":not(:checked)")){o("#scalesortorderasc").prop("checked",!0)}}else{o(".competencyreport input[name=optionscalefilter]").prop("checked",!1);o(".competencyreport input[name=optionscalefilter]").prop("disabled",!0);o(".competencyreport input[name=optionscalesortorder]").prop("disabled",!0);o(".competencyreport input[name=optionscalesortorder]").prop("checked",!1)}e.changeScaleApplyHandler();e.changeScaleSortorderHandler();e.resetUserUsingLPTemplateSelection();var n=JSON.stringify(t);o(e.learningplanSelector).data("scalefilter",n)};h.prototype.changeScaleApplyHandler=function(){var e=this;e.scalefilterin="";if(o("#scalefilterplan").is(":checked")){e.scalefilterin=""}if(o("#scalefiltercourse").is(":checked")){e.scalefilterin="course"}if(o("#scalefiltercoursemodule").is(":checked")){e.scalefilterin="coursemodule"}o(e.learningplanSelector).data("scalefilterapply",e.scalefilterin)};h.prototype.changeScaleSortorderHandler=function(){var e=this;e.scalesortorder="ASC";if(o("#scalesortorderdesc").is(":checked")){e.scalesortorder="DESC"}o(e.learningplanSelector).data("scalesortorder",e.scalesortorder)};h.prototype.changeWithcommentsHandler=function(){var e=this;e.withcomments=o("#filter-comment").is(":checked");o(e.learningplanSelector).data("withcomments",e.withcomments)};h.prototype.changeWithplansHandler=function(){var e=this;e.withplans=o("#filter-plan").is(":checked");o(e.learningplanSelector).data("withplans",e.withplans)};h.prototype.displayEvidencelist=function(t,o){var l=this;if(0<t.listevidence.length){a.get_string("listofevidence","tool_lp").done(function(n){return c.create({type:c.types.DEFAULT,title:n,body:e.render("report_lpmonitoring/list_evidences_in_competency",t),large:!0}).done(function(e){e.getRoot().on(p.hidden,function(){e.destroy();l.focusContentItem(o)}.bind(this));e.getRoot().on(p.bodyRendered,function(){g.apply("#listevidencecompetency-"+t.competencyid,!0,!0)}.bind(this));e.show()}.bind(this))}).fail(n.exception)}};h.prototype.displayCourselist=function(t,o){var l=this;if(0<t.listtotalcourses.length){a.get_string("linkedcourses","tool_lp").done(function(n){return c.create({type:c.types.DEFAULT,title:n,body:e.render("report_lpmonitoring/list_courses_in_competency",t),large:!0}).done(function(e){e.getRoot().on(p.hidden,function(){e.destroy();l.focusContentItem(o)}.bind(this));e.getRoot().on(p.bodyRendered,function(){g.apply("#listcoursecompetency-"+t.competencyid,!0,!0)}.bind(this));e.show()}.bind(this))}).fail(n.exception)}};h.prototype.displayCmlist=function(t,o){var l=this;if(0<t.listtotalcms.length){a.get_string("linkedcms","report_lpmonitoring").done(function(n){return c.create({type:c.types.DEFAULT,title:n,body:e.render("report_lpmonitoring/list_cms_in_competency",t),large:!0}).done(function(e){e.getRoot().on(p.hidden,function(){e.destroy();l.focusContentItem(o)}.bind(this));e.getRoot().on(p.bodyRendered,function(){g.apply("#listcmcompetency-"+t.competencyid,!0,!0)}.bind(this));e.show()}.bind(this))}).fail(n.exception)}};h.prototype.displayPlan=function(l,r,c){var p=null,i=this;if(o("#plan-user-info").length){p=o("#plan-user-info")}else{p=o("#reportFilter button")}p.addClass("loading");o(".competencyreport .competency-detail a.collapse-link").css("visibility","hidden");i.scalesvaluesSelected=!1===i.userView?i.scalesvaluesSelected:"";var s=t.call([{methodname:"report_lpmonitoring_read_plan",args:{planid:parseInt(l),templateid:parseInt(r),scalevalues:i.scalesvaluesSelected,scalefilterin:i.scalefilterin,scalesortorder:i.scalesortorder,tagid:parseInt(c),withcomments:i.withcomments,withplans:i.withplans}}]);s[0].then(function(t){t.templateid=parseInt(r);M.cfg.contextid=t.plan.usercontext;if(!1===t.hasnavigation){o(".plan-info-container").addClass("nonavigation")}else{o(".plan-info-container").removeClass("nonavigation")}t.navigationclosed=!1;if(o(".plan-info-container").hasClass("closed")){t.navigationclosed=!0}if(!1===i.userView){return e.render("report_lpmonitoring/user_info",t).done(function(n){o("#userInfoContainer").html(n);i.loadListCompetencies(t.plan,p);return e.render("report_lpmonitoring/users_list_navigation",t).done(function(e){o("#users-list-full-navigation").html(e)})})}else{a.get_string("learningplancompetencies","report_lpmonitoring",t.plan.name).done(function(e){o("#planInfoContainer h3").text(e);i.loadListCompetencies(t.plan,p)})}}).fail(function(t){p.removeClass("loading");if("emptytemplate"===t.errorcode){return e.render("report_lpmonitoring/user_info",{exception:t}).done(function(e){o("#userInfoContainer").html(e);o("#listPlanCompetencies").empty();o("#plan-stats-report").empty();o("#report-content").empty();o("#summary-content").empty();o("#nav-tabs").hide();o("#users-list-full-navigation").empty()})}else{n.exception(t)}})};h.prototype.displayScaleCourseList=function(t,o){var l=this;if(0<t.scalecompetencyitem.listcourses.length){a.get_string("linkedcourses","tool_lp").done(function(n){return c.create({type:c.types.DEFAULT,title:n,body:e.render("report_lpmonitoring/list_courses_in_scale_value",t),large:!0}).done(function(e){e.getRoot().on(p.hidden,function(){e.destroy();l.focusContentItem(o)}.bind(this));e.getRoot().on(p.bodyRendered,function(){g.apply("#listscalecoursecompetency-"+t.competencyid,!0,!0);l.colorContrast.apply(".moodle-dialogue-base .badge.cr-scalename")}.bind(this));e.show()}.bind(this))}).fail(n.exception)}};h.prototype.displayScaleCmList=function(t,o){var l=this;if(0<t.scalecompetencyitem.listcms.length){a.get_string("linkedcms","report_lpmonitoring").done(function(n){return c.create({type:c.types.DEFAULT,title:n,body:e.render("report_lpmonitoring/list_cms_in_scale_value",t),large:!0}).done(function(e){e.getRoot().on(p.hidden,function(){e.destroy();l.focusContentItem(o)}.bind(this));e.getRoot().on(p.bodyRendered,function(){g.apply("#listscalecmcompetency-"+t.competencyid,!0,!0);l.colorContrast.apply(".moodle-dialogue-base .badge.cr-scalename")}.bind(this));e.show()}.bind(this))}).fail(n.exception)}};h.prototype.focusContentItem=function(e){if(e.is("input:not([type=\"hidden\"]), a[href], button, textarea, select, [tabindex]")){e.focus()}else{e.find("input:not([type=\"hidden\"]), a[href], button, textarea, select, [tabindex]").first().focus()}};h.prototype.resetGrade=function(o,a,l){var r=this,c=!1;if(null===l){c=!0}var p=new y(c);p.on("rated",function(c,e){var p=t.call([{methodname:"report_lpmonitoring_reset_grading",args:{planid:o,competencyid:l,note:e.note}}]);p[0].then(function(){if(null===l){r.displayPlan(o,r.templateId,r.tagId)}else{r.reloadCompetencyDetail(l,a,o)}}).fail(function(e){n.exception(e)})});p.display()};h.prototype.initPage=function(){var e=this;a.get_strings([{key:"selectuser",component:"report_lpmonitoring"},{key:"nouserselected",component:"report_lpmonitoring"}]).done(function(t){r.enhance(e.learningplanSelector,!1,"report_lpmonitoring/learningplan",t[0],!1,!0,t[1]);r.enhance(e.studentSelector,!1,"tool_lp/form-user-selector",t[0],!1,!0,t[1]);if(!1===e.userView){if(o(".competencyreport #student").is(":checked")){o(".competencyreport .templatefilter").toggleClass("disabled-option",!0);o(".competencyreport .tagfilter").toggleClass("disabled-option",!0)}else if(o(".competencyreport #tag").is(":checked")){o(".competencyreport .studentfilter").toggleClass("disabled-option",!0);o(".competencyreport .templatefilter").toggleClass("disabled-option",!0)}else{o(".competencyreport .studentfilter").toggleClass("disabled-option",!0);o(".competencyreport .tagfilter").toggleClass("disabled-option",!0)}}e.checkDataFormReady()}).fail(n.exception);o(".competencyreport").on("click",".moreless-toggler",function(e){e.preventDefault();o(".advanced").toggle();o(this).toggleClass("hidden").siblings().removeClass("hidden")});d.init();o(".competencyreport").on("click",".collapse-link",function(a){a.preventDefault();var l=o(this).closest(".x_panel"),e=o(this).find("i"),t=l.find(".x_content");e.toggleClass("fa-chevron-right fa-chevron-down");t.slideToggle();l.toggleClass("panel-collapsed")});o(".competencyreport").on("click","a.scaleinfo",function(t){t.preventDefault();var n=o(t.target).closest("td"),a=o(this).data("competencyid"),l=o(this).data("scalevalue"),r=o(this).data("type");if("undefined"!=typeof e.competencies[a]){var c={},p=e.competencies[a].competencydetail;c.scalecompetencyitem=p.scalecompetencyitems[l-1];c.competencyid=a;if("incm"===r){e.displayScaleCmList(c,n)}else{e.displayScaleCourseList(c,n)}}});o(".competencyreport #student").on("change",function(){if(o(this).is(":checked")){o(".competencyreport .studentfilter").toggleClass("disabled-option",!1);o(".competencyreport .templatefilter").toggleClass("disabled-option",!0);o(".competencyreport .tagfilter").toggleClass("disabled-option",!0)}e.checkDataFormReady()});o(".competencyreport #template").on("change",function(){if(o(this).is(":checked")){o(".competencyreport .studentfilter").toggleClass("disabled-option",!0);o(".competencyreport .templatefilter").toggleClass("disabled-option",!1);o(".competencyreport .tagfilter").toggleClass("disabled-option",!0)}e.checkDataFormReady()});o(".competencyreport #tag").on("change",function(){if(o(this).is(":checked")){e.loadTags();o(".competencyreport .studentfilter").toggleClass("disabled-option",!0);o(".competencyreport .templatefilter").toggleClass("disabled-option",!0);o(".competencyreport .tagfilter").toggleClass("disabled-option",!1)}e.checkDataFormReady()});o(document).on("submit","#reportFilter",function(){e.submitFormHandler();return!1});o(".competencyreport").on("click","a.navigatetoplan",function(t){t.preventDefault();var n=o(this).data("planid"),a=o(this).data("templateid"),l=o(this).data("tagid");e.displayPlan(n,a,l)});o(".competencyreport").on("click",".toggle-lp-list-users",function(e){e.preventDefault();o(this).find("i.angle").toggleClass("fa-angle-double-right fa-angle-double-left");o(this).closest(".plan-info-container").toggleClass("closed");o("div[data-region=\"blocks-lp-list-users\"]").toggleClass("lp-list-users-closed")});o(".competencyreport").on("click",".plan-info-container .table-list-users .nav-list-users-displayinfo",function(e){e.stopPropagation();e.preventDefault();o(this).find("i.fa").toggleClass("fa-angle-down fa-angle-up");o(this).parent().find("span.item-nav-list-users-info").toggleClass("hidden")});o(".competencyreport").on("click",".plan-info-container .table-list-users tr",function(t){t.preventDefault();var n=o(this).data("planid"),a=o(this).data("templateid"),l=o(this).data("tagid");e.displayPlan(n,a,l)});o(".competencyreport").on("click","a.listevidence",function(t){t.preventDefault();var n=o(t.target),a=o(this).data("competencyid");if("undefined"!=typeof e.competencies[a]){var l={listevidence:e.competencies[a].competencydetail.listevidence,competencyid:a};e.displayEvidencelist(l,n)}});o(".competencyreport").on("click","a.totalnbcourses",function(t){t.preventDefault();var n=o(t.target),a=o(this).data("competencyid");if("undefined"!=typeof e.competencies[a]){var l={listtotalcourses:e.competencies[a].competencydetail.listtotalcourses,competencyid:a};e.displayCourselist(l,n)}});o(".competencyreport").on("click","a.totalnbcms",function(t){t.preventDefault();var n=o(t.target),a=o(this).data("competencyid");if("undefined"!=typeof e.competencies[a]){var l={listtotalcms:e.competencies[a].competencydetail.listtotalcms,competencyid:a};e.displayCmlist(l,n)}});o(".competencyreport").on("click",".detail-comp-tab a",function(t){t.preventDefault();if(o(t.target).hasClass("incm")){e.compDetailActiveTab="incoursemodule"}else{e.compDetailActiveTab="incourse"}});o(".competencyreport").on("click",".resetdisplayrating a",function(t){t.preventDefault();var n=o(this).data("canresetdisplayrating-plan");e.resetDisplayRating(n)});o(".competencyreport").on("click",".reset-grade a",function(t){t.preventDefault();var n=o(this).data("resetgrade-plan"),a=o(this).data("competencyid"),l=o(this).data("userid");e.resetGrade(n,l,a)});o(".competencyreport").on("click",".reset-grade-all a",function(t){t.preventDefault();var n=o(this).data("resetgrade-plan"),a=o(this).data("userid");e.resetGrade(n,a,null)});a.get_strings([{key:"collapseall"},{key:"expandall"}]).done(function(e){var t=e[0],n=e[1];o(".competencyreport").on("click",".collapsible-actions a",function(e){e.preventDefault();if(o(this).hasClass("collapse-all")){o(this).text(n);o("#listPlanCompetencies div.x_panel:not(.panel-collapsed) a.collapse-link").trigger("click")}else{o(this).text(t);o("#listPlanCompetencies div.panel-collapsed a.collapse-link").trigger("click")}o(this).toggleClass("collapse-all expand-all")})}).fail(n.exception)};return{init:function init(e,t){return new h(e,t)},processResults:function processResults(e,t){var n=[];o.each(t,function(e,t){n.push({value:t.planid,label:t._label})});return n},transport:function transport(n,a,l,r){var c,p=o(n).data("scalefilterapply"),i=o(n).data("scalesortorder");i=i?i:"ASC";var s=o(n).data("withcomments");s=s?s:!1;var d=o(n).data("withplans");d=d?d:!1;var m=o(n).data("templateid");if(""===m){return[]}c=t.call([{methodname:"report_lpmonitoring_search_users_by_templateid",args:{query:a,templateid:parseInt(m),scalevalues:o(n).data("scalefilter"),scalefilterin:p,scalesortorder:i,withcomments:s,withplans:d}}]);c[0].then(function(t){var n=[],a=0;o.each(t,function(t,a){var l=a,r=[];o.each(["idnumber","email","phone1","phone2","department","institution"],function(e,t){if("undefined"!=typeof a[t]&&""!==a[t]){l.hasidentity=!0;r.push(a[t])}});l.identity=r.join(", ");n.push(e.render("report_lpmonitoring/form-user-selector-suggestion",l))});return o.when.apply(o.when,n).then(function(){var e=arguments;o.each(t,function(t,n){n._label=e[a];a++});l(t)})},r)}}});
//# sourceMappingURL=learningplan.min.js.map
