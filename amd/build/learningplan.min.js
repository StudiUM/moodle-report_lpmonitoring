define(["jquery","core/templates","core/ajax","core/notification","core/str","report_lpmonitoring/Chart","core/form-autocomplete","tool_lp/dialogue","report_lpmonitoring/user_competency_popup","tool_lp/grade_user_competency_inline","report_lpmonitoring/fieldsettoggler","report_lpmonitoring/colorcontrast","report_lpmonitoring/paginated_datatable"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=function(b){this.userView=b||!1,this.initPage(),this.colorContrast=l.init();var c=this,d=new i("[data-region=list-competencies-section]","[data-user-competency=true]");d._refresh=function(){var a=this;c.reloadCompetencyDetail(a._competencyId,a._userId,a._planId)},a(this.templateSelector).on("change",this.templateChangeHandler.bind(this)).change(),a(this.learningplanSelector).on("change",this.learningplanChangeHandler.bind(this)).change(),a(this.studentSelector).on("change",this.studentChangeHandler.bind(this)).change(),a(this.studentPlansSelector).on("change",this.studentPlansChangeHandler.bind(this)).change(),a(".competencyreport").on("change",'.scalefiltercontainer input[name="optionscalefilter"]',this.changeScaleApplyHandler.bind(this)).change(),a(".competencyreport").on("change",'.scalesortordercontainer input[name="optionscalesortorder"]',this.changeScaleSortorderHandler.bind(this)).change(),a(".competencyreport").on("change",".scalefiltervalues",this.changeScaleHandler.bind(this)).change(),a(".competencyreport input[name=optionfilter]").prop("disabled",!1),a(".competencyreport input[name=optionscalesortorder]").prop("disabled",!1)};return n.prototype.templateId=null,n.prototype.userView=!1,n.prototype.learningplanId=null,n.prototype.studentLearningplanId=null,n.prototype.userId=null,n.prototype.templateSelected=null,n.prototype.studentSelected=null,n.prototype.competencies={},n.prototype.scalesvaluesSelected=null,n.prototype.colorcontrast=null,n.prototype.scalefilterbycourse=null,n.prototype.scalesortorder="ASC",n.prototype.templateSelector="#templateSelectorReport",n.prototype.learningplanSelector="#learningplanSelectorReport",n.prototype.studentSelector="#studentSelectorReport",n.prototype.studentPlansSelector="#studentPlansSelectorReport",n.prototype.templateChangeHandler=function(b){var c=this;c.templateId=a(b.target).val(),a(c.learningplanSelector).data("templateid",c.templateId),a(c.learningplanSelector).data("scalefilter",""),a(c.learningplanSelector).data("scalesortorder",""),c.resetUserUsingLPTemplateSelection(),c.learningplanId=null,""!==c.templateId?(a(".competencyreport .moreless-actions").removeClass("hidden"),a(".competencyreport .show-toggler").hasClass("hidden")&&a(".competencyreport .fitem_scales").show(),c.loadScalesFromTemplate(c.templateId)):(a(".competencyreport .moreless-actions").addClass("hidden"),a(".competencyreport .fitem_scales").hide(),a(".competencyreport #scale").empty()),c.checkDataFormReady()},n.prototype.resetUserUsingLPTemplateSelection=function(){var b=this,c=a(".competencyreport .templatefilter .form-autocomplete-selection"),d=c.find('span[aria-selected="true"]');b.learningplanId=null,d.length&&(d.remove(),a(b.learningplanSelector+" option").remove(),e.get_string("nostudentselected","report_lpmonitoring").done(function(b){c.append(a("<span>").text(b))}))},n.prototype.loadScalesFromTemplate=function(e){var f=c.call([{methodname:"report_lpmonitoring_get_scales_from_template",args:{templateid:parseInt(e)}}]);f[0].then(function(c){var d={};d.scales=c,b.render("report_lpmonitoring/scale_filter",d).done(function(c,d){a(".competencyreport #scale").html(c),b.runTemplateJS(d)}),c.length>0?(a(".competencyreport #scalefilterapply").show(),b.render("report_lpmonitoring/scale_filter_apply",d).done(function(c,d){a(".competencyreport #scalefilter").html(c),b.runTemplateJS(d)}),a(".competencyreport #scalesortorderlabel").show(),b.render("report_lpmonitoring/scale_filter_sortorder",d).done(function(c,d){a(".competencyreport #scalesortorder").html(c),b.runTemplateJS(d)})):(a(".competencyreport #scalefilterapply").hide(),a(".competencyreport #scalesortorderlabel").hide(),a(".competencyreport #scalefilter").html(""),a(".competencyreport #scalesortorder").html(""))}).fail(function(a){d.exception(a)})},n.prototype.buildLearningplanOptions=function(b){var c=this;a(c.scaleSelector+" option").remove(),a(c.scaleSelector).append(a("<option>")),a.each(b,function(b,d){a(c.scaleSelector).append(a("<option>").text(d.name).val(d.id))})},n.prototype.learningplanChangeHandler=function(b){var c=this;c.learningplanId=a(b.target).val(),c.checkDataFormReady()},n.prototype.studentChangeHandler=function(b){var f=this;if(f.userId=a(b.target).val(),null!==f.userId){var g=c.call([{methodname:"core_competency_list_user_plans",args:{userid:f.userId}}]);g[0].then(function(b){a(f.studentPlansSelector+" option").remove(),b.length>0?(a(f.studentPlansSelector).prop("disabled",!1),a.each(b,function(b,c){a(f.studentPlansSelector).append(a("<option>").text(c.name).val(c.id))})):(a(f.studentPlansSelector).prop("disabled",!0),e.get_string("nolearningplanavailable","report_lpmonitoring").done(function(b){a(f.studentPlansSelector).append(a("<option>").text(b).val(""))})),a(f.studentPlansSelector).trigger("change")},d.exception)}f.checkDataFormReady()},n.prototype.studentPlansChangeHandler=function(b){var c=this;c.studentLearningplanId=a(b.target).val(),c.checkDataFormReady()},n.prototype.checkDataFormReady=function(){var b=this,c=!1,d=!1;b.userView===!1?(c=a("#template").is(":checked")&&""!==a(b.templateSelector).val(),d=a("#student").is(":checked")&&null!==a(b.studentSelector).val()&&null!==a(b.studentPlansSelector).val()&&""!==a(b.studentPlansSelector).val()):d=null!==a(b.studentPlansSelector).val()&&""!==a(b.studentPlansSelector).val(),c||d?a("#submitFilterReportButton").removeAttr("disabled"):a("#submitFilterReportButton").attr("disabled","disabled")},n.prototype.loadListCompetencies=function(e,f){var g=this,h=c.call([{methodname:"report_lpmonitoring_list_plan_competencies",args:{id:e.id}}]);h[0].then(function(c){if(c.length>0){var d={competencies_list:c,plan:e,hascompetencies:!0};return b.render("report_lpmonitoring/list_competencies",d).done(function(d,h){a("#listPlanCompetencies").html(d),b.runTemplateJS(h),g.loadCompetencyDetail(c,e,f)})}return f.removeClass("loading"),b.render("report_lpmonitoring/list_competencies",{}).done(function(c,d){a("#listPlanCompetencies").html(c),b.runTemplateJS(d)})}).fail(function(a){f.removeClass("loading"),d.exception(a)})},n.prototype.loadCompetencyDetail=function(d,e,f){var g=[],h=this;a.each(d,function(a,b){h.competencies[b.competency.id]={usercompetency:b.usercompetency},g.push({methodname:"report_lpmonitoring_get_competency_detail",args:{competencyid:b.competency.id,userid:e.user.id,planid:e.id}})});var i=c.call(g);a.each(i,function(c,d){d.then(function(d){h.competencies[d.competencyid].competencydetail=d,d.plan=e,b.render("report_lpmonitoring/competency_detail",d).done(function(i,j){var k=d.competencyid,l=e.user.id,m=e.id,n=d.scaleid;a("#comp-"+k+" .x_content").html(i),d.cangrade&&h.applyInlineGrader(k,l,m,n),d.hasrating!==!1&&h.ApplyDonutGraph(k,d),c===g.length-1&&(f.removeClass("loading"),a(".competencyreport .competency-detail a.collapse-link").css("visibility","")),b.runTemplateJS(j),h.colorContrast.apply("#comp-"+k+" .x_content .tile-stats .label.cr-scalename")})})})},n.prototype.applyInlineGrader=function(a,b,c,d){var f=this;e.get_string("chooserating","tool_lp").done(function(e){var g=new j("#rate_"+a,d,a,b,c,"",e);g.on("competencyupdated",function(){f.reloadCompetencyDetail(a,b,c)})})},n.prototype.reloadCompetencyDetail=function(d,e,f){var g=this;g.competencies[d]={};var h=g.scalefilterbycourse===!1?0:1,i=c.call([{methodname:"core_competency_read_plan",args:{id:f}},{methodname:"report_lpmonitoring_get_competency_detail",args:{competencyid:d,userid:e,planid:f}},{methodname:"report_lpmonitoring_read_plan",args:{scalevalues:"",templateid:null,planid:f,scalefilterbycourse:h}}]);i[0].then(function(c){i[1].then(function(d){g.competencies[d.competencyid].competencydetail=d,d.plan=c,b.render("report_lpmonitoring/competency_detail",d).done(function(c,h){a("#comp-"+d.competencyid+" .x_content").html(c),b.runTemplateJS(h),d.cangrade&&g.applyInlineGrader(d.competencyid,e,f,d.scaleid),d.hasrating!==!1&&g.ApplyDonutGraph(d.competencyid,d),g.colorContrast.apply("#comp-"+d.competencyid+" .x_content .tile-stats .label.cr-scalename")}),b.render("report_lpmonitoring/competency_proficiency",d).done(function(c,e){a("#comp-"+d.competencyid+" span.level").html(c),b.runTemplateJS(e)}),i[2].then(function(c){b.render("report_lpmonitoring/plan_stats_report",{plan:c.plan,hascompetencies:!0}).done(function(c,d){a("#plan-stats-report").html(c),b.runTemplateJS(d)})})})})},n.prototype.ApplyDonutGraph=function(b,c){var d={legend:!1,responsive:!1,tooltips:{enabled:!1}},e=[],g=[];a.each(c.scalecompetencyitems,function(a,b){e.push(b.color),g.push(b.nbcourse)}),new f(a("#canvas-graph-"+b),{type:"doughnut",data:{labels:[],datasets:[{data:g,backgroundColor:e,hoverBackgroundColor:[]}]},options:d})},n.prototype.submitFormHandler=function(){var b=this,c=a("#template").is(":checked"),d=null,e=null;c===!0?(d=b.templateId,e=b.learningplanId):e=b.studentLearningplanId,b.scalesvaluesSelected=a(b.learningplanSelector).data("scalefilter"),b.displayPlan(e,d)},n.prototype.changeScaleHandler=function(){var b=this,c=[];a(".competencyreport .scalefiltervalues").each(function(){a(this).is(":checked")&&c.push({scalevalue:a(this).data("scalevalue"),scaleid:a(this).data("scaleid")})}),c.length>0?(a(".competencyreport input[name=optionscalefilter]").prop("disabled",!1),a(".competencyreport input[name=optionscalesortorder]").prop("disabled",!1),a("#scalefiltercourse").is(":not(:checked)")&&a("#scalefilterplan").is(":not(:checked)")&&a("#scalefiltercourse").prop("checked",!0),a("#scalesortorderasc").is(":not(:checked)")&&a("#scalesortorderdesc").is(":not(:checked)")&&a("#scalesortorderasc").prop("checked",!0)):(a(".competencyreport input[name=optionscalefilter]").prop("checked",!1),a(".competencyreport input[name=optionscalefilter]").prop("disabled",!0),a(".competencyreport input[name=optionscalesortorder]").prop("disabled",!0),a(".competencyreport input[name=optionscalesortorder]").prop("checked",!1)),b.changeScaleApplyHandler(),b.changeScaleSortorderHandler(),b.resetUserUsingLPTemplateSelection();var d=JSON.stringify(c);a(b.learningplanSelector).data("scalefilter",d)},n.prototype.changeScaleApplyHandler=function(){var b=this;b.scalefilterbycourse="",a("#scalefilterplan").is(":checked")&&(b.scalefilterbycourse=!1),a("#scalefiltercourse").is(":checked")&&(b.scalefilterbycourse=!0),a(b.learningplanSelector).data("scalefilterapply",b.scalefilterbycourse)},n.prototype.changeScaleSortorderHandler=function(){var b=this;b.scalesortorder="ASC",a("#scalesortorderdesc").is(":checked")&&(b.scalesortorder="DESC"),a(b.learningplanSelector).data("scalesortorder",b.scalesortorder)},n.prototype.displayEvidencelist=function(a){var c=this;a.listevidence.length>0&&e.get_string("listofevidence","tool_lp").done(function(e){b.render("report_lpmonitoring/list_evidences_in_competency",a).done(function(b){new h(e,b,function(){m.apply("#listevidencecompetency-"+a.competencyid)},c.destroyDialogue)}).fail(d.exception)})},n.prototype.destroyDialogue=function(a){a.close()},n.prototype.displayCourselist=function(a){var c=this;a.listtotalcourses.length>0&&e.get_string("linkedcourses","tool_lp").done(function(e){b.render("report_lpmonitoring/list_courses_in_competency",a).done(function(b){new h(e,b,function(){m.apply("#listcoursecompetency-"+a.competencyid)},c.destroyDialogue)}).fail(d.exception)})},n.prototype.displayPlan=function(f,g){var h=null,i=this;h=a(a("#plan-user-info").length?"#plan-user-info":"#reportFilter button"),h.addClass("loading"),a(".competencyreport .competency-detail a.collapse-link").css("visibility","hidden");var j=i.scalefilterbycourse===!1?0:1;i.scalesvaluesSelected=i.userView===!1?i.scalesvaluesSelected:"";var k=c.call([{methodname:"report_lpmonitoring_read_plan",args:{planid:parseInt(f),templateid:parseInt(g),scalevalues:i.scalesvaluesSelected,scalefilterbycourse:j,scalesortorder:i.scalesortorder}}]);k[0].then(function(c){return c.templateid=parseInt(g),i.userView===!1?b.render("report_lpmonitoring/user_info",c).done(function(b){a("#userInfoContainer").html(b),i.loadListCompetencies(c.plan,h)}):void e.get_string("learningplancompetencies","report_lpmonitoring",c.plan.name).done(function(b){a("#planInfoContainer h3").text(b),i.loadListCompetencies(c.plan,h)})}).fail(function(c){if(h.removeClass("loading"),"emptytemplate"===c.errorcode){var e={exception:c};return b.render("report_lpmonitoring/user_info",e).done(function(b){a("#userInfoContainer").html(b),a("#listPlanCompetencies").empty(),a("#plan-stats-report").empty()})}d.exception(c)})},n.prototype.displayScaleCourseList=function(a){var c=this;a.scalecompetencyitem.listcourses.length>0&&e.get_string("linkedcourses","tool_lp").done(function(e){b.render("report_lpmonitoring/list_courses_in_scale_value",a).done(function(b){new h(e,b,function(){m.apply("#listscalecoursecompetency-"+a.competencyid)},c.destroyDialogue),c.colorContrast.apply(".moodle-dialogue-base .label.cr-scalename")}).fail(d.exception)})},n.prototype.initPage=function(){var b=this;e.get_strings([{key:"selectstudent",component:"report_lpmonitoring"},{key:"nostudentselected",component:"report_lpmonitoring"}]).done(function(c){g.enhance(b.learningplanSelector,!1,"report_lpmonitoring/learningplan",c[0],!1,!0,c[1]),g.enhance(b.studentSelector,!1,"tool_lp/form-user-selector",c[0],!1,!0,c[1]),b.userView===!1&&(a(".competencyreport #student").is(":checked")?a(".competencyreport .templatefilter").addClass("disabled-option"):a(".competencyreport .studentfilter").addClass("disabled-option")),b.checkDataFormReady()}).fail(d.exception),a(".competencyreport").on("click",".moreless-toggler",function(b){b.preventDefault(),a(this).toggleClass("hidden").siblings().removeClass("hidden"),a(".fitem_scales").slideToggle("slow")}),k.init(),a(".competencyreport").on("click",".collapse-link",function(){var b=a(this).closest(".x_panel"),c=a(this).find("i"),d=b.find(".x_content");c.toggleClass("fa-chevron-right fa-chevron-down"),d.slideToggle(),b.toggleClass("panel-collapsed")}),a(".competencyreport").on("click","a.scaleinfo",function(){var c=a(this).data("competencyid"),d=a(this).data("scalevalue");if("undefined"!=typeof b.competencies[c]){var e={},f=b.competencies[c].competencydetail;e.scalecompetencyitem=f.scalecompetencyitems[d-1],e.competencyid=c,b.displayScaleCourseList(e)}}),a(".competencyreport #student").on("change",function(){a(this).is(":checked")&&(a(".competencyreport .studentfilter").toggleClass("disabled-option"),a(".competencyreport .templatefilter").toggleClass("disabled-option")),b.checkDataFormReady()}),a(".competencyreport #template").on("change",function(){a(this).is(":checked")&&(a(".competencyreport .studentfilter").toggleClass("disabled-option"),a(".competencyreport .templatefilter").toggleClass("disabled-option")),b.checkDataFormReady()}),a(document).on("submit","#reportFilter",function(){return b.submitFormHandler(),!1}),a(".competencyreport").on("click","a.navigatetoplan",function(c){c.preventDefault();var d=a(this).data("planid"),e=a(this).data("templateid");b.displayPlan(d,e)}),a(".competencyreport").on("click","a.listevidence",function(c){c.preventDefault();var d=a(this).data("competencyid");if("undefined"!=typeof b.competencies[d]){var e={};e.listevidence=b.competencies[d].competencydetail.listevidence,e.competencyid=d,b.displayEvidencelist(e)}}),a(".competencyreport").on("click","a.totalnbcourses",function(c){c.preventDefault();var d=a(this).data("competencyid");if("undefined"!=typeof b.competencies[d]){var e={};e.listtotalcourses=b.competencies[d].competencydetail.listtotalcourses,e.competencyid=d,b.displayCourselist(e)}}),e.get_strings([{key:"collapseall"},{key:"expandall"}]).done(function(b){var c=b[0],d=b[1];a(".competencyreport").on("click",".collapsible-actions a",function(b){b.preventDefault(),a(this).hasClass("collapse-all")?(a(this).text(d),a("#listPlanCompetencies div.x_panel:not(.panel-collapsed) a.collapse-link").trigger("click")):(a(this).text(c),a("#listPlanCompetencies div.panel-collapsed a.collapse-link").trigger("click")),a(this).toggleClass("collapse-all expand-all")})}).fail(d.exception)},{init:function(a){return new n(a)},processResults:function(b,c){var d=[];return a.each(c,function(a,b){d.push({value:b.planid,label:b._label})}),d},transport:function(d,e,f,g){var h,i=a(d).data("scalefilterapply"),j=a(d).data("scalesortorder");j=j?j:"ASC";var k=i===!1?0:1,l=a(d).data("templateid");return""===l?[]:(h=c.call([{methodname:"report_lpmonitoring_search_users_by_templateid",args:{query:e,templateid:parseInt(l),scalevalues:a(d).data("scalefilter"),scalefilterbycourse:k,scalesortorder:j}}]),void h[0].then(function(c){var d=[],e=0;return a.each(c,function(c,e){var f=e,g=[];a.each(["idnumber","email","phone1","phone2","department","institution"],function(a,b){"undefined"!=typeof e[b]&&""!==e[b]&&(f.hasidentity=!0,g.push(e[b]))}),f.identity=g.join(", "),d.push(b.render("report_lpmonitoring/form-user-selector-suggestion",f))}),a.when.apply(a.when,d).then(function(){var b=arguments;a.each(c,function(a,c){c._label=b[e],e++}),f(c)})},g))}}});