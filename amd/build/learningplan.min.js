define("report_lpmonitoring/learningplan",["jquery","core/templates","core/ajax","core/notification","core/str","core/chartjs","core/form-autocomplete","core/modal_factory","core/modal_events","report_lpmonitoring/user_competency_popup","tool_lp/grade_user_competency_inline","report_lpmonitoring/fieldsettoggler","report_lpmonitoring/colorcontrast","report_lpmonitoring/paginated_datatable","report_lpmonitoring/resetgrade_dialogue"],(function($,templates,ajax,notification,str,Chart,autocomplete,ModalFactory,ModalEvents,Popup,InlineGrader,fieldsettoggler,colorcontrast,DataTable,ResetGradeDialogue){var LearningplanReport=function(userview,cmcompgradingenabled){this.userView=userview||!1,this.cmcompgradingEnabled=cmcompgradingenabled||!1,this.initPage(),this.colorContrast=colorcontrast.init();var learningplan=this;new Popup("[data-region=list-competencies-section]","[data-user-competency=true]")._refresh=function(){learningplan.reloadCompetencyDetail(this._competencyId,this._userId,this._planId),this.close()},$(this.templateSelector).on("change",this.templateChangeHandler.bind(this)).change(),$(this.learningplanSelector).on("change",this.learningplanChangeHandler.bind(this)).change(),$(this.studentSelector).on("change",this.studentChangeHandler.bind(this)).change(),$(this.studentPlansSelector).on("change",this.studentPlansChangeHandler.bind(this)).change(),$(this.tagSelector).on("change",this.tagChangeHandler.bind(this)).change(),$(this.learningplanTagSelector).on("change",this.learningplanTagChangeHandler.bind(this)).change(),$(this.learningplanTagCommentsSelector).on("change",this.learningplanTagChangeHandler.bind(this)).change(),$(".competencyreport").on("change",'.scalefiltercontainer input[name="optionscalefilter"]',this.changeScaleApplyHandler.bind(this)).change(),$(".competencyreport").on("change",'.scalesortordercontainer input[name="optionscalesortorder"]',this.changeScaleSortorderHandler.bind(this)).change(),$(".competencyreport").on("change",".scalefiltervalues",this.changeScaleHandler.bind(this)).change(),$(".competencyreport input[name=optionfilter]").prop("disabled",!1),$(".competencyreport input[name=optionscalesortorder]").prop("disabled",!1),$(".competencyreport").on("change",".displayratings input[type=checkbox]",this.changeDisplayRating.bind(this)).change(),$(".competencyreport").on("change","#filter-comment",this.changeWithcommentsHandler.bind(this)).change(),$(".competencyreport").on("change","#filter-plan",this.changeWithplansHandler.bind(this)).change(),$(".competencyreport").on("DOMSubtreeModified",".tags-stats",this.reloadTagsIfNeeded.bind(this)),$(".competencyreport").on("change","#filter-comments",this.reloadTagsIfNeeded.bind(this))};return LearningplanReport.prototype.templateId=null,LearningplanReport.prototype.userView=!1,LearningplanReport.prototype.learningplanId=null,LearningplanReport.prototype.studentLearningplanId=null,LearningplanReport.prototype.tagLearningplanId=null,LearningplanReport.prototype.tagId=null,LearningplanReport.prototype.userId=null,LearningplanReport.prototype.templateSelected=null,LearningplanReport.prototype.studentSelected=null,LearningplanReport.prototype.competencies={},LearningplanReport.prototype.scalesvaluesSelected=null,LearningplanReport.prototype.colorcontrast=null,LearningplanReport.prototype.scalefilterin="",LearningplanReport.prototype.scalesortorder="ASC",LearningplanReport.prototype.withcomments=!1,LearningplanReport.prototype.withplans=!1,LearningplanReport.prototype.cmcompgradingEnabled=!1,LearningplanReport.prototype.templateSelector="#templateSelectorReport",LearningplanReport.prototype.learningplanSelector="#learningplanSelectorReport",LearningplanReport.prototype.studentSelector="#studentSelectorReport",LearningplanReport.prototype.studentPlansSelector="#studentPlansSelectorReport",LearningplanReport.prototype.tagSelector="#tagSelectorReport",LearningplanReport.prototype.learningplanTagSelector="#learningplanTagSelectorReport",LearningplanReport.prototype.learningplanTagCommentsSelector="#filter-comments",LearningplanReport.prototype.tagsAreLoading=!1,LearningplanReport.prototype.compDetailActiveTab=null,LearningplanReport.prototype.templateChangeHandler=function(e){this.templateId=$(e.target).val(),$(this.learningplanSelector).data("templateid",this.templateId),$(this.learningplanSelector).data("scalefilter",""),$(this.learningplanSelector).data("scalesortorder",""),this.resetUserUsingLPTemplateSelection(),this.learningplanId=null,""!==this.templateId?($(".competencyreport .moreless-actions").removeClass("hidden"),$(".competencyreport .show-toggler").hasClass("hidden")&&$(".competencyreport .advanced").show(),this.loadScalesFromTemplate(this.templateId),this.disableUserTemplateSelector(!1)):($(".competencyreport .moreless-actions").addClass("hidden"),$(".competencyreport .advanced").hide(),$(".competencyreport #scale").empty(),this.disableUserTemplateSelector(!0)),this.checkDataFormReady()},LearningplanReport.prototype.loadTags=function(){var self=this;!1===self.tagsAreLoading&&(self.tagsAreLoading=!0,$(self.tagSelector+" option").remove(),ajax.call([{methodname:"report_lpmonitoring_search_tags_for_accessible_plans",args:{}}])[0].then((function(results){str.get_string("selecttag","report_lpmonitoring").done((function(selecttag){$(self.tagSelector).append($("<option>").text(selecttag).val("")),$.each(results,(function(index,tag){$(self.tagSelector).append($("<option>").text(tag.tag).val(tag.id))})),!0===$(self.tagSelector+" option[value="+self.tagId+"]").length>0?$(self.tagSelector).val(self.tagId):(self.tagId=null,self.tagLearningplanId=null),$(self.tagSelector).change(),self.tagsAreLoading=!1}))})).fail((function(exp){notification.exception(exp),self.tagsAreLoading=!1})))},LearningplanReport.prototype.reloadTagsIfNeeded=function(event){event.preventDefault(),$(".competencyreport #tag").is(":checked")&&this.loadTags()},LearningplanReport.prototype.tagChangeHandler=function(e){var self=this;self.tagId=$(e.target).val(),self.withcomments=$("#filter-comments").is(":checked"),""==self.tagId&&(self.tagId=null),ajax.call([{methodname:"report_lpmonitoring_search_plans_with_tag",args:{tagid:self.tagId,withcomments:self.withcomments}}])[0].then((function(results){var label="",oldTagLearningplanId=self.tagLearningplanId;$(self.learningplanTagSelector+" option").remove(),results.length>0?str.get_string("selectlearningplan","report_lpmonitoring").done((function(selectlearningplan){$(self.learningplanTagSelector).append($("<option>").text(selectlearningplan).val("")),$.each(results,(function(index,plan){label=plan.fullname+" - "+plan.planname,$(self.learningplanTagSelector).append($("<option>").text(label).val(plan.planid))})),$(self.learningplanTagSelector).prop("disabled",!1);var selectorOption=self.learningplanTagSelector+" option[value="+oldTagLearningplanId+"]";!0===$(selectorOption).length>0?($(self.learningplanTagSelector).val(oldTagLearningplanId),self.tagLearningplanId=oldTagLearningplanId):self.tagLearningplanId=null})):($(self.learningplanTagSelector).prop("disabled",!0),str.get_string("nolearningplanavailable","report_lpmonitoring").done((function(nolearningplanavailable){$(self.learningplanTagSelector).append($("<option>").text(nolearningplanavailable).val(""))}))),$(self.learningplanTagSelector).trigger("change")})).fail((function(exp){notification.exception(exp)})),self.checkDataFormReady()},LearningplanReport.prototype.learningplanTagChangeHandler=function(e){this.tagLearningplanId=$(e.target).val(),this.checkDataFormReady()},LearningplanReport.prototype.changeDisplayRating=function(e){var displayrating=0;$(e.target).is(":checked")&&(displayrating=1);var planid=$(e.target).data("displayrating-plan"),promise=ajax.call([{methodname:"tool_lp_set_display_rating_for_plan",args:{planid:planid,visible:displayrating}},{methodname:"tool_lp_can_reset_display_rating_for_plan",args:{planid:planid}}]);promise[0].then((function(){promise[1].then((function(canresetdisplayrating){displayrating?$(".competencyreport .displayratings input[type=checkbox]").prop("checked",!0):$(".competencyreport .displayratings input[type=checkbox]").prop("checked",!1),canresetdisplayrating&&$(".competencyreport .resetdisplayrating").show()})).fail((function(exp){notification.exception(exp)}))})).fail((function(exp){notification.exception(exp)}))},LearningplanReport.prototype.resetDisplayRating=function(planid){var promise=ajax.call([{methodname:"tool_lp_reset_display_rating_for_plan",args:{planid:planid}},{methodname:"tool_lp_has_to_display_rating",args:{planid:planid}}]);promise[0].then((function(){promise[1].then((function(displayrating){displayrating?$(".competencyreport .displayratings input[type=checkbox]").prop("checked",!0):$(".competencyreport .displayratings input[type=checkbox]").prop("checked",!1),$(".competencyreport .resetdisplayrating").hide()})).fail((function(exp){notification.exception(exp)}))})).fail((function(exp){notification.exception(exp)}))},LearningplanReport.prototype.resetUserUsingLPTemplateSelection=function(){var autocomplete=$(".competencyreport .templatefilter .form-autocomplete-selection"),selection=autocomplete.find('span[aria-selected="true"]');this.learningplanId=null,selection.length&&(selection.remove(),$(this.learningplanSelector+" option").remove(),str.get_string("nouserselected","report_lpmonitoring").done((function(nouserselected){autocomplete.append($("<span>").text(nouserselected))})))},LearningplanReport.prototype.disableUserTemplateSelector=function(){let state=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var userAutocomplete=$(".competencyreport .templatefilter .for-autocomplete .fautocomplete .position-relative"),inputSelector=userAutocomplete.find(":text"),arrowSelector=userAutocomplete.find(".form-autocomplete-downarrow");inputSelector.length>0&&inputSelector.prop("disabled",state),arrowSelector.length>0&&arrowSelector.toggleClass("disabled-option",state)},LearningplanReport.prototype.loadScalesFromTemplate=function(templateid){var self=this;ajax.call([{methodname:"report_lpmonitoring_get_scales_from_template",args:{templateid:parseInt(templateid)}}])[0].then((function(results){var context={};context.scales=results,context.cmcompgradingenabled=self.cmcompgradingEnabled,templates.render("report_lpmonitoring/scale_filter",context).done((function(html,js){$(".competencyreport #scale").html(html),templates.runTemplateJS(js)})),results.length>0?($(".competencyreport #scalefilterapply").show(),templates.render("report_lpmonitoring/scale_filter_apply",context).done((function(html,js){$(".competencyreport #scalefilter").html(html),templates.runTemplateJS(js)})),$(".competencyreport #scalesortorderlabel").show(),templates.render("report_lpmonitoring/scale_filter_sortorder",context).done((function(html,js){$(".competencyreport #scalesortorder").html(html),templates.runTemplateJS(js)}))):($(".competencyreport #scalefilterapply").hide(),$(".competencyreport #scalesortorderlabel").hide(),$(".competencyreport #scalefilter").html(""),$(".competencyreport #scalesortorder").html(""))})).fail((function(exp){notification.exception(exp)}))},LearningplanReport.prototype.buildLearningplanOptions=function(options){var self=this;$(self.scaleSelector+" option").remove(),$(self.scaleSelector).append($("<option>")),$.each(options,(function(key,value){$(self.scaleSelector).append($("<option>").text(value.name).val(value.id))}))},LearningplanReport.prototype.learningplanChangeHandler=function(e){this.learningplanId=$(e.target).val(),this.checkDataFormReady()},LearningplanReport.prototype.studentChangeHandler=function(e){var self=this;(self.userId=$(e.target).val(),self.userId)&&ajax.call([{methodname:"core_competency_list_user_plans",args:{userid:self.userId}}])[0].then((function(results){$(self.studentPlansSelector+" option").remove(),results.length>0?($(self.studentPlansSelector).prop("disabled",!1),$.each(results,(function(key,value){$(self.studentPlansSelector).append($("<option>").text(value.name).val(value.id))}))):($(self.studentPlansSelector).prop("disabled",!0),str.get_string("nolearningplanavailable","report_lpmonitoring").done((function(nolearningplanavailable){$(self.studentPlansSelector).append($("<option>").text(nolearningplanavailable).val(""))}))),$(self.studentPlansSelector).trigger("change")}),notification.exception);self.checkDataFormReady()},LearningplanReport.prototype.studentPlansChangeHandler=function(e){this.studentLearningplanId=$(e.target).val(),this.checkDataFormReady()},LearningplanReport.prototype.checkDataFormReady=function(){var conditionByTemplate=!1,conditionStudent=!1,conditionByTag=!1;!1===this.userView?(conditionByTemplate=$("#template").is(":checked")&&""!==$(this.templateSelector).val(),conditionStudent=$("#student").is(":checked")&&null!==$(this.studentSelector).val()&&void 0!==$("option:selected",$(this.studentSelector)).attr("value")&&null!==$("option:selected",$(this.studentPlansSelector)).attr("value")&&void 0!==$("option:selected",$(this.studentPlansSelector)).attr("value")&&""!==$("option:selected",$(this.studentPlansSelector)).attr("value"),conditionByTag=$("#tag").is(":checked")&&""!==$(this.tagSelector).val()):conditionStudent=null!==$(this.studentPlansSelector).val()&&""!==$(this.studentPlansSelector).val(),conditionByTemplate||conditionStudent||conditionByTag?$("#submitFilterReportButton").removeAttr("disabled"):$("#submitFilterReportButton").attr("disabled","disabled")},LearningplanReport.prototype.loadListCompetencies=function(plan,elementloading){var self=this;ajax.call([{methodname:"report_lpmonitoring_list_plan_competencies",args:{id:plan.id}}])[0].then((function(results){if(results.length>0){var competencies={competencies_list:results,plan:plan,hascompetencies:!0};templates.render("report_lpmonitoring/list_competencies",competencies).done((function(html,js){$("#listPlanCompetencies").html(html),templates.runTemplateJS(js),self.loadCompetencyDetail(results,plan,elementloading),$("#nav-tabs").removeClass("hidden")}))}else elementloading.removeClass("loading"),templates.render("report_lpmonitoring/list_competencies",{}).done((function(html,js){$("#listPlanCompetencies").html(html),templates.runTemplateJS(js),$("#report-content").empty(),$("#summary-content").empty(),$("#nav-tabs").addClass("hidden")}));self.loadSummaryTab(plan),self.loadReportTab(plan)})).fail((function(exp){elementloading.removeClass("loading"),notification.exception(exp)}))},LearningplanReport.prototype.loadCompetencyDetail=function(competencies,plan,element){var requests=[],self=this;$.each(competencies,(function(index,record){self.competencies[record.competency.id]={usercompetency:record.usercompetency},requests.push({methodname:"report_lpmonitoring_get_competency_detail",args:{competencyid:record.competency.id,userid:plan.user.id,planid:plan.id}})}));var promises=ajax.call(requests);$.each(promises,(function(index,promise){promise.then((function(context){self.competencies[context.competencyid].competencydetail=context,context.plan=plan,context.plan.userid=plan.user.id,context.cmcompgradingenabled=self.cmcompgradingEnabled,templates.render("report_lpmonitoring/competency_detail",context).done((function(html,js){var compid=context.competencyid,userid=plan.user.id,planid=plan.id,scaleid=context.scaleid;$("#comp-"+compid+" .x_content").html(html),"incoursemodule"===self.compDetailActiveTab?$('.detail-comp-tab a[href="#tab-incms-content-'+context.competencyid+'"]').tab("show"):$('.detail-comp-tab a[href="#tab-incourses-content-'+context.competencyid+'"]').tab("show"),context.cangrade&&self.applyInlineGrader(compid,userid,planid,scaleid),!1!==context.hasrating&&self.ApplyDonutGraph(compid,context,!1),!1!==context.hasratingincms&&self.cmcompgradingEnabled&&self.ApplyDonutGraph(compid,context,!0),index===requests.length-1&&(element.removeClass("loading"),$(".competencyreport .competency-detail a.collapse-link").css("visibility","")),templates.runTemplateJS(js),self.colorContrast.apply("#comp-"+compid+" .x_content .tile-stats .badge.cr-scalename")}))}))}))},LearningplanReport.prototype.loadReportTab=function(plan){var learningplan=this;ajax.call([{methodname:"report_lpmonitoring_list_plan_competencies_report",args:{id:plan.id}}])[0].then((function(results){if(results.competencies_list.length>0){var competencies={reportinfos:results,plan:plan,hascompetencies:!0},checkedvalue=$("input[type=radio][name=reportfilter]:checked").val();"course"==checkedvalue?competencies.filterchecked_course=!0:"module"==checkedvalue?competencies.filterchecked_module=!0:competencies.filterchecked_both=!0,competencies.tablesearchvalue=$("#table-search-competency").val(),competencies.tablesearchvaluecolumn=$("#table-search-columns").val(),competencies.scalefilterreport=$("#scale-filter-report option:selected").val(),templates.render("report_lpmonitoring/datatable",competencies).done((function(html,js){$("#report-content").html(html),templates.runTemplateJS(js),new Popup("[data-region=report-competencies-section]","[data-user-competency=true]")._refresh=function(){learningplan.reloadCompetencyDetail(this._competencyId,this._userId,this._planId),this.close()}}))}else{competencies={hascompetencies:!1};templates.render("report_lpmonitoring/datatable",competencies).done((function(html,js){$("#report-content").html(html),templates.runTemplateJS(js)}))}})).fail((function(exp){notification.exception(exp)}))},LearningplanReport.prototype.loadSummaryTab=function(plan){var learningplan=this;ajax.call([{methodname:"report_lpmonitoring_list_plan_competencies_summary",args:{id:plan.id}}])[0].then((function(results){if(results.scale_competency.length>0){var competencies={reportinfos:results,plan:plan,hascompetencies:!0},checkedvalue=$("input[type=radio][name=summaryfilter]:checked").val();"course"==checkedvalue?competencies.filterchecked_course=!0:"module"==checkedvalue?competencies.filterchecked_module=!0:competencies.filterchecked_both=!0;for(var scaleselected=$("#scale-filter-summary").val(),i=0;i<competencies.reportinfos.scale_competency.length;i++){var scaleid=competencies.reportinfos.scale_competency[i].scaleid;competencies.reportinfos.scale_competency[i].scaleselected=!1,scaleid==scaleselected&&(competencies.reportinfos.scale_competency[i].scaleselected=!0);var searchvalue=$("#summary-search-competency-"+scaleid).val();competencies.reportinfos.scale_competency[i].tablesearchvalue=searchvalue}templates.render("report_lpmonitoring/summary",competencies).done((function(html,js){$("#summary-content").html(html),templates.runTemplateJS(js),new Popup("[data-region=summary-competencies-section]","[data-user-competency=true]")._refresh=function(){learningplan.reloadCompetencyDetail(this._competencyId,this._userId,this._planId),this.close()}}))}else{competencies={hascompetencies:!1};templates.render("report_lpmonitoring/summary",competencies).done((function(html,js){$("#summary-content").html(html),templates.runTemplateJS(js)}))}})).fail((function(exp){notification.exception(exp)}))},LearningplanReport.prototype.applyInlineGrader=function(competencyid,userid,planid,scaleid){var self=this;str.get_string("chooserating","tool_lp").done((function(chooserateoption){new InlineGrader("#rate_"+competencyid,scaleid,competencyid,userid,planid,"",chooserateoption).on("competencyupdated",(function(){self.reloadCompetencyDetail(competencyid,userid,planid)}))}))},LearningplanReport.prototype.reloadCompetencyDetail=function(competencyid,userid,planid){var self=this;self.competencies[competencyid]={};var promise=ajax.call([{methodname:"core_competency_read_plan",args:{id:planid}},{methodname:"report_lpmonitoring_get_competency_detail",args:{competencyid:competencyid,userid:userid,planid:planid}},{methodname:"report_lpmonitoring_read_plan",args:{scalevalues:"",templateid:null,planid:planid,scalefilterin:self.scalefilterin,tagid:null,withcomments:!1,withplans:!1}}]);promise[0].then((function(plan){promise[1].then((function(results){self.competencies[results.competencyid].competencydetail=results,results.plan=plan,results.cmcompgradingenabled=self.cmcompgradingEnabled,templates.render("report_lpmonitoring/competency_detail",results).done((function(html,js){$("#comp-"+results.competencyid+" .x_content").html(html),templates.runTemplateJS(js),"incoursemodule"===self.compDetailActiveTab?$('.detail-comp-tab a[href="#tab-incms-content-'+results.competencyid+'"]').tab("show"):$('.detail-comp-tab a[href="#tab-incourses-content-'+results.competencyid+'"]').tab("show"),results.cangrade&&self.applyInlineGrader(results.competencyid,userid,planid,results.scaleid),!1!==results.hasrating&&self.ApplyDonutGraph(results.competencyid,results,!1),!1!==results.hasratingincm&&self.cmcompgradingEnabled&&self.ApplyDonutGraph(results.competencyid,results,!0),self.colorContrast.apply("#comp-"+results.competencyid+" .x_content .tile-stats .badge.cr-scalename")})),templates.render("report_lpmonitoring/competency_proficiency",results).done((function(html,js){$("#comp-"+results.competencyid+" span.level").html(html),templates.runTemplateJS(js)})),promise[2].then((function(results){templates.render("report_lpmonitoring/plan_stats_report",{plan:results.plan,hascompetencies:!0}).done((function(html,js){$("#plan-stats-report").html(html),templates.runTemplateJS(js)}))}))}))}))},LearningplanReport.prototype.ApplyDonutGraph=function(competencyid,data,forcm){var colors=[],canvasselector="#canvas-graph-"+competencyid;forcm&&(canvasselector="#cm-canvas-graph-"+competencyid);var itemsbyscales=[];$.each(data.scalecompetencyitems,(function(index,record){colors.push(record.color),forcm?itemsbyscales.push(record.nbcm):itemsbyscales.push(record.nbcourse)})),new Chart($(canvasselector),{type:"doughnut",data:{labels:[],datasets:[{data:itemsbyscales,backgroundColor:colors,hoverBackgroundColor:[]}]},options:{legend:!1,responsive:!1,tooltips:{enabled:!1}}})},LearningplanReport.prototype.submitFormHandler=function(){var templateSelected=$("#template").is(":checked"),tagSelected=$("#tag").is(":checked"),templateid=null,planid=null,tagid=null;!0===templateSelected?(templateid=this.templateId,planid=this.learningplanId,this.withcomments=$("#filter-comment").is(":checked"),this.withplans=$("#filter-plan").is(":checked")):!0===tagSelected?(tagid=this.tagId,planid=this.tagLearningplanId):planid=this.studentLearningplanId,this.scalesvaluesSelected=$(this.learningplanSelector).data("scalefilter"),"coursemodule"===this.scalefilterin?this.compDetailActiveTab="incoursemodule":this.compDetailActiveTab="incourse",this.displayPlan(planid,templateid,tagid)},LearningplanReport.prototype.changeScaleHandler=function(){var scalefiltervalues=[];$(".competencyreport .scalefiltervalues").each((function(){$(this).is(":checked")&&scalefiltervalues.push({scalevalue:$(this).data("scalevalue"),scaleid:$(this).data("scaleid")})})),scalefiltervalues.length>0?($(".competencyreport input[name=optionscalefilter]").prop("disabled",!1),$(".competencyreport input[name=optionscalesortorder]").prop("disabled",!1),$("#scalefiltercourse").is(":not(:checked)")&&$("#scalefilterplan").is(":not(:checked)")&&(this.cmcompgradingEnabled?$("#scalefiltercoursemodule").prop("checked",!0):$("#scalefiltercourse").prop("checked",!0)),$("#scalesortorderasc").is(":not(:checked)")&&$("#scalesortorderdesc").is(":not(:checked)")&&$("#scalesortorderasc").prop("checked",!0)):($(".competencyreport input[name=optionscalefilter]").prop("checked",!1),$(".competencyreport input[name=optionscalefilter]").prop("disabled",!0),$(".competencyreport input[name=optionscalesortorder]").prop("disabled",!0),$(".competencyreport input[name=optionscalesortorder]").prop("checked",!1)),this.changeScaleApplyHandler(),this.changeScaleSortorderHandler(),this.resetUserUsingLPTemplateSelection();var filterscaleinputs=JSON.stringify(scalefiltervalues);$(this.learningplanSelector).data("scalefilter",filterscaleinputs)},LearningplanReport.prototype.changeScaleApplyHandler=function(){this.scalefilterin="",$("#scalefilterplan").is(":checked")&&(this.scalefilterin=""),$("#scalefiltercourse").is(":checked")&&(this.scalefilterin="course"),$("#scalefiltercoursemodule").is(":checked")&&(this.scalefilterin="coursemodule"),$(this.learningplanSelector).data("scalefilterapply",this.scalefilterin)},LearningplanReport.prototype.changeScaleSortorderHandler=function(){this.scalesortorder="ASC",$("#scalesortorderdesc").is(":checked")&&(this.scalesortorder="DESC"),$(this.learningplanSelector).data("scalesortorder",this.scalesortorder)},LearningplanReport.prototype.changeWithcommentsHandler=function(){this.withcomments=$("#filter-comment").is(":checked"),$(this.learningplanSelector).data("withcomments",this.withcomments)},LearningplanReport.prototype.changeWithplansHandler=function(){this.withplans=$("#filter-plan").is(":checked"),$(this.learningplanSelector).data("withplans",this.withplans)},LearningplanReport.prototype.displayEvidencelist=function(evidences,trigger){var self=this;evidences.listevidence.length>0&&str.get_string("listofevidence","tool_lp").done((function(title){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:title,body:templates.render("report_lpmonitoring/list_evidences_in_competency",evidences),large:!0}).done(function(modal){modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy(),self.focusContentItem(trigger)}.bind(this)),modal.getRoot().on(ModalEvents.bodyRendered,function(){DataTable.apply("#listevidencecompetency-"+evidences.competencyid,!0,!0)}.bind(this)),modal.show()}.bind(this))})).fail(notification.exception)},LearningplanReport.prototype.displayCourselist=function(listcourses,trigger){var self=this;listcourses.listtotalcourses.length>0&&str.get_string("linkedcourses","tool_lp").done((function(title){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:title,body:templates.render("report_lpmonitoring/list_courses_in_competency",listcourses),large:!0}).done(function(modal){modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy(),self.focusContentItem(trigger)}.bind(this)),modal.getRoot().on(ModalEvents.bodyRendered,function(){DataTable.apply("#listcoursecompetency-"+listcourses.competencyid,!0,!0)}.bind(this)),modal.show()}.bind(this))})).fail(notification.exception)},LearningplanReport.prototype.displayCmlist=function(listcms,trigger){var self=this;listcms.listtotalcms.length>0&&str.get_string("linkedcms","report_lpmonitoring").done((function(title){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:title,body:templates.render("report_lpmonitoring/list_cms_in_competency",listcms),large:!0}).done(function(modal){modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy(),self.focusContentItem(trigger)}.bind(this)),modal.getRoot().on(ModalEvents.bodyRendered,function(){DataTable.apply("#listcmcompetency-"+listcms.competencyid,!0,!0)}.bind(this)),modal.show()}.bind(this))})).fail(notification.exception)},LearningplanReport.prototype.displayPlan=function(planid,templateid,tagid){var elementloading=null,self=this;(elementloading=$("#plan-user-info").length?$("#plan-user-info"):$("#reportFilter button")).addClass("loading"),$(".competencyreport .competency-detail a.collapse-link").css("visibility","hidden"),self.scalesvaluesSelected=!1===self.userView?self.scalesvaluesSelected:"",ajax.call([{methodname:"report_lpmonitoring_read_plan",args:{planid:parseInt(planid),templateid:parseInt(templateid),scalevalues:self.scalesvaluesSelected,scalefilterin:self.scalefilterin,scalesortorder:self.scalesortorder,tagid:parseInt(tagid),withcomments:self.withcomments,withplans:self.withplans}}])[0].then((function(results){if(results.templateid=parseInt(templateid),M.cfg.contextid=results.plan.usercontext,!1===results.hasnavigation?$(".plan-info-container").addClass("nonavigation"):$(".plan-info-container").removeClass("nonavigation"),results.navigationclosed=!1,$(".plan-info-container").hasClass("closed")&&(results.navigationclosed=!0),!1===self.userView)return templates.render("report_lpmonitoring/user_info",results).done((function(html){return $("#userInfoContainer").html(html),self.loadListCompetencies(results.plan,elementloading),templates.render("report_lpmonitoring/users_list_navigation",results).done((function(html){$("#users-list-full-navigation").html(html)}))}));str.get_string("learningplancompetencies","report_lpmonitoring",results.plan.name).done((function(planname){$("#planInfoContainer h3").text(planname),self.loadListCompetencies(results.plan,elementloading)}))})).fail((function(exp){if(elementloading.removeClass("loading"),"emptytemplate"===exp.errorcode){var exception={exception:exp};return templates.render("report_lpmonitoring/user_info",exception).done((function(html){$("#userInfoContainer").html(html),$("#listPlanCompetencies").empty(),$("#plan-stats-report").empty(),$("#report-content").empty(),$("#summary-content").empty(),$("#nav-tabs").hide(),$("#users-list-full-navigation").empty()}))}notification.exception(exp)}))},LearningplanReport.prototype.displayScaleCourseList=function(listcourses,trigger){var self=this;listcourses.scalecompetencyitem.listcourses.length>0&&str.get_string("linkedcourses","tool_lp").done((function(title){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:title,body:templates.render("report_lpmonitoring/list_courses_in_scale_value",listcourses),large:!0}).done(function(modal){modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy(),self.focusContentItem(trigger)}.bind(this)),modal.getRoot().on(ModalEvents.bodyRendered,function(){DataTable.apply("#listscalecoursecompetency-"+listcourses.competencyid,!0,!0),self.colorContrast.apply(".moodle-dialogue-base .badge.cr-scalename")}.bind(this)),modal.show()}.bind(this))})).fail(notification.exception)},LearningplanReport.prototype.displayScaleCmList=function(listitems,trigger){var self=this;listitems.scalecompetencyitem.listcms.length>0&&str.get_string("linkedcms","report_lpmonitoring").done((function(title){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:title,body:templates.render("report_lpmonitoring/list_cms_in_scale_value",listitems),large:!0}).done(function(modal){modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy(),self.focusContentItem(trigger)}.bind(this)),modal.getRoot().on(ModalEvents.bodyRendered,function(){DataTable.apply("#listscalecmcompetency-"+listitems.competencyid,!0,!0),self.colorContrast.apply(".moodle-dialogue-base .badge.cr-scalename")}.bind(this)),modal.show()}.bind(this))})).fail(notification.exception)},LearningplanReport.prototype.focusContentItem=function(item){var focusable='input:not([type="hidden"]), a[href], button, textarea, select, [tabindex]';item.is(focusable)?item.focus():item.find(focusable).first().focus()},LearningplanReport.prototype.resetGrade=function(planid,userid,competencyid){var self=this,allcompetencies=!1;null===competencyid&&(allcompetencies=!0);var dialogue=new ResetGradeDialogue(allcompetencies);dialogue.on("rated",(function(e,data){ajax.call([{methodname:"report_lpmonitoring_reset_grading",args:{planid:planid,competencyid:competencyid,note:data.note}}])[0].then((function(){null===competencyid?self.displayPlan(planid,self.templateId,self.tagId):self.reloadCompetencyDetail(competencyid,userid,planid)})).fail((function(exp){notification.exception(exp)}))})),dialogue.display()},LearningplanReport.prototype.initPage=function(){var self=this;str.get_strings([{key:"selectuser",component:"report_lpmonitoring"},{key:"nouserselected",component:"report_lpmonitoring"}]).done((function(strings){autocomplete.enhance(self.learningplanSelector,!1,"report_lpmonitoring/learningplan",strings[0],!1,!0,strings[1]).then((()=>self.disableUserTemplateSelector())),autocomplete.enhance(self.studentSelector,!1,"tool_lp/form-user-selector",strings[0],!1,!0,strings[1]),!1===self.userView&&($(".competencyreport #student").is(":checked")?($(".competencyreport .templatefilter").toggleClass("disabled-option",!0),$(".competencyreport .tagfilter").toggleClass("disabled-option",!0)):$(".competencyreport #tag").is(":checked")?($(".competencyreport .studentfilter").toggleClass("disabled-option",!0),$(".competencyreport .templatefilter").toggleClass("disabled-option",!0)):($(".competencyreport .studentfilter").toggleClass("disabled-option",!0),$(".competencyreport .tagfilter").toggleClass("disabled-option",!0))),self.checkDataFormReady()})).fail(notification.exception),$(".competencyreport").on("click",".moreless-toggler",(function(event){event.preventDefault(),$(".advanced").toggle(),$(this).toggleClass("hidden").siblings().removeClass("hidden")})),fieldsettoggler.init(),$(".competencyreport").on("click",".collapse-link",(function(event){event.preventDefault();var e=$(this).closest(".x_panel"),t=$(this).find("i"),n=e.find(".x_content");t.toggleClass("fa-chevron-right fa-chevron-down"),n.slideToggle(),e.toggleClass("panel-collapsed")})),$(".competencyreport").on("click","a.scaleinfo",(function(event){event.preventDefault();var trigger=$(event.target).closest("td"),competencyid=$(this).data("competencyid"),scalevalue=$(this).data("scalevalue"),type=$(this).data("type");if(void 0!==self.competencies[competencyid]){var listitems={},competencydetail=self.competencies[competencyid].competencydetail;listitems.scalecompetencyitem=competencydetail.scalecompetencyitems[scalevalue-1],listitems.competencyid=competencyid,"incm"===type?self.displayScaleCmList(listitems,trigger):self.displayScaleCourseList(listitems,trigger)}})),$(".competencyreport #student").on("change",(function(){$(this).is(":checked")&&($(".competencyreport .studentfilter").toggleClass("disabled-option",!1),$(".competencyreport .templatefilter").toggleClass("disabled-option",!0),$(".competencyreport .tagfilter").toggleClass("disabled-option",!0)),self.checkDataFormReady()})),$(".competencyreport #template").on("change",(function(){$(this).is(":checked")&&($(".competencyreport .studentfilter").toggleClass("disabled-option",!0),$(".competencyreport .templatefilter").toggleClass("disabled-option",!1),$(".competencyreport .tagfilter").toggleClass("disabled-option",!0)),self.checkDataFormReady()})),$(".competencyreport #tag").on("change",(function(){$(this).is(":checked")&&(self.loadTags(),$(".competencyreport .studentfilter").toggleClass("disabled-option",!0),$(".competencyreport .templatefilter").toggleClass("disabled-option",!0),$(".competencyreport .tagfilter").toggleClass("disabled-option",!1)),self.checkDataFormReady()})),$(document).on("submit","#reportFilter",(function(){return self.submitFormHandler(),!1})),$(".competencyreport").on("click","a.navigatetoplan",(function(event){event.preventDefault();var planid=$(this).data("planid"),templateid=$(this).data("templateid"),tagid=$(this).data("tagid");self.displayPlan(planid,templateid,tagid)})),$(".competencyreport").on("click",".toggle-lp-list-users",(function(event){event.preventDefault(),$(this).find("i.angle").toggleClass("fa-angle-double-right fa-angle-double-left"),$(this).closest(".plan-info-container").toggleClass("closed"),$('div[data-region="blocks-lp-list-users"]').toggleClass("lp-list-users-closed")}));$(".competencyreport").on("click",".plan-info-container .table-list-users .nav-list-users-displayinfo",(function(event){event.stopPropagation(),event.preventDefault(),$(this).find("i.fa").toggleClass("fa-angle-down fa-angle-up"),$(this).parent().find("span.item-nav-list-users-info").toggleClass("hidden")})),$(".competencyreport").on("click",".plan-info-container .table-list-users tr",(function(event){event.preventDefault();var planid=$(this).data("planid"),templateid=$(this).data("templateid"),tagid=$(this).data("tagid");self.displayPlan(planid,templateid,tagid)})),$(".competencyreport").on("click","a.listevidence",(function(event){event.preventDefault();var trigger=$(event.target),competencyid=$(this).data("competencyid");if(void 0!==self.competencies[competencyid]){var listevidence={};listevidence.listevidence=self.competencies[competencyid].competencydetail.listevidence,listevidence.competencyid=competencyid,self.displayEvidencelist(listevidence,trigger)}})),$(".competencyreport").on("click","a.totalnbcourses",(function(event){event.preventDefault();var trigger=$(event.target),competencyid=$(this).data("competencyid");if(void 0!==self.competencies[competencyid]){var totallistcourses={};totallistcourses.listtotalcourses=self.competencies[competencyid].competencydetail.listtotalcourses,totallistcourses.competencyid=competencyid,self.displayCourselist(totallistcourses,trigger)}})),$(".competencyreport").on("click","a.totalnbcms",(function(event){event.preventDefault();var trigger=$(event.target),competencyid=$(this).data("competencyid");if(void 0!==self.competencies[competencyid]){var totallistcms={};totallistcms.listtotalcms=self.competencies[competencyid].competencydetail.listtotalcms,totallistcms.competencyid=competencyid,self.displayCmlist(totallistcms,trigger)}})),$(".competencyreport").on("click",".detail-comp-tab a",(function(event){event.preventDefault(),$(event.target).hasClass("incm")?self.compDetailActiveTab="incoursemodule":self.compDetailActiveTab="incourse"})),$(".competencyreport").on("click",".resetdisplayrating a",(function(event){event.preventDefault();var planid=$(this).data("canresetdisplayrating-plan");self.resetDisplayRating(planid)})),$(".competencyreport").on("click",".reset-grade a",(function(event){event.preventDefault();var planid=$(this).data("resetgrade-plan"),competencyid=$(this).data("competencyid"),userid=$(this).data("userid");self.resetGrade(planid,userid,competencyid)})),$(".competencyreport").on("click",".reset-grade-all a",(function(event){event.preventDefault();var planid=$(this).data("resetgrade-plan"),userid=$(this).data("userid");self.resetGrade(planid,userid,null)})),str.get_strings([{key:"collapseall"},{key:"expandall"}]).done((function(strings){var collapseall=strings[0],expandall=strings[1];$(".competencyreport").on("click",".collapsible-actions a",(function(event){event.preventDefault(),$(this).hasClass("collapse-all")?($(this).text(expandall),$("#listPlanCompetencies div.x_panel:not(.panel-collapsed) a.collapse-link").trigger("click")):($(this).text(collapseall),$("#listPlanCompetencies div.panel-collapsed a.collapse-link").trigger("click")),$(this).toggleClass("collapse-all expand-all")}))})).fail(notification.exception)},{init:function(userview,cmcompgradingenabled){return new LearningplanReport(userview,cmcompgradingenabled)},processResults:function(selector,results){var users=[];return $.each(results,(function(index,userplan){users.push({value:userplan.planid,label:userplan._label})})),users},transport:function(selector,query,success,failure){var scalefilterapply=$(selector).data("scalefilterapply"),scalesortorder=$(selector).data("scalesortorder");scalesortorder=scalesortorder||"ASC";var withcomments=$(selector).data("withcomments");withcomments=withcomments||!1;var withplans=$(selector).data("withplans");withplans=withplans||!1;var templateid=$(selector).data("templateid");if(""===templateid)return[];ajax.call([{methodname:"report_lpmonitoring_search_users_by_templateid",args:{query:query,templateid:parseInt(templateid),scalevalues:$(selector).data("scalefilter"),scalefilterin:scalefilterapply,scalesortorder:scalesortorder,withcomments:withcomments,withplans:withplans}}])[0].then((function(results){var promises=[],i=0;return $.each(results,(function(index,user){var ctx=user,identity=[];$.each(["idnumber","email","phone1","phone2","department","institution"],(function(i,k){void 0!==user[k]&&""!==user[k]&&(ctx.hasidentity=!0,identity.push(user[k]))})),ctx.identity=identity.join(", "),promises.push(templates.render("report_lpmonitoring/form-user-selector-suggestion",ctx))})),$.when.apply($.when,promises).then((function(){var args=arguments;$.each(results,(function(index,user){user._label=args[i],i++})),success(results)}))}),failure)}}}));

//# sourceMappingURL=learningplan.min.js.map