define(["jquery","core/templates","core/ajax","core/notification","core/str","core/chartjs","core/form-autocomplete","tool_lp/dialogue","report_lpmonitoring/user_competency_popup","tool_lp/grade_user_competency_inline","report_lpmonitoring/fieldsettoggler","report_lpmonitoring/colorcontrast","report_lpmonitoring/paginated_datatable","report_lpmonitoring/resetgrade_dialogue"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=function(b,c){this.userView=b||!1,this.cmcompgradingEnabled=c||!1,this.initPage(),this.colorContrast=l.init();var d=this,e=new i("[data-region=list-competencies-section]","[data-user-competency=true]");e._refresh=function(){var a=this;d.reloadCompetencyDetail(a._competencyId,a._userId,a._planId),a.close()},a(this.templateSelector).on("change",this.templateChangeHandler.bind(this)).change(),a(this.learningplanSelector).on("change",this.learningplanChangeHandler.bind(this)).change(),a(this.studentSelector).on("change",this.studentChangeHandler.bind(this)).change(),a(this.studentPlansSelector).on("change",this.studentPlansChangeHandler.bind(this)).change(),a(this.tagSelector).on("change",this.tagChangeHandler.bind(this)).change(),a(this.learningplanTagSelector).on("change",this.learningplanTagChangeHandler.bind(this)).change(),a(this.learningplanTagCommentsSelector).on("change",this.learningplanTagChangeHandler.bind(this)).change(),a(".competencyreport").on("change",'.scalefiltercontainer input[name="optionscalefilter"]',this.changeScaleApplyHandler.bind(this)).change(),a(".competencyreport").on("change",'.scalesortordercontainer input[name="optionscalesortorder"]',this.changeScaleSortorderHandler.bind(this)).change(),a(".competencyreport").on("change",".scalefiltervalues",this.changeScaleHandler.bind(this)).change(),a(".competencyreport input[name=optionfilter]").prop("disabled",!1),a(".competencyreport input[name=optionscalesortorder]").prop("disabled",!1),a(".competencyreport").on("change",".displayratings input[type=checkbox]",this.changeDisplayRating.bind(this)).change(),a(".competencyreport").on("change","#filter-comment",this.changeWithcommentsHandler.bind(this)).change(),a(".competencyreport").on("change","#filter-plan",this.changeWithplansHandler.bind(this)).change(),a(".competencyreport").on("DOMSubtreeModified",".tags-stats",this.reloadTagsIfNeeded.bind(this)),a(".competencyreport").on("change","#filter-comments",this.reloadTagsIfNeeded.bind(this))};return o.prototype.templateId=null,o.prototype.userView=!1,o.prototype.learningplanId=null,o.prototype.studentLearningplanId=null,o.prototype.tagLearningplanId=null,o.prototype.tagId=null,o.prototype.userId=null,o.prototype.templateSelected=null,o.prototype.studentSelected=null,o.prototype.competencies={},o.prototype.scalesvaluesSelected=null,o.prototype.colorcontrast=null,o.prototype.scalefilterin="",o.prototype.scalesortorder="ASC",o.prototype.withcomments=!1,o.prototype.withplans=!1,o.prototype.cmcompgradingEnabled=!1,o.prototype.templateSelector="#templateSelectorReport",o.prototype.learningplanSelector="#learningplanSelectorReport",o.prototype.studentSelector="#studentSelectorReport",o.prototype.studentPlansSelector="#studentPlansSelectorReport",o.prototype.tagSelector="#tagSelectorReport",o.prototype.learningplanTagSelector="#learningplanTagSelectorReport",o.prototype.learningplanTagCommentsSelector="#filter-comments",o.prototype.tagsAreLoading=!1,o.prototype.compDetailActiveTab=null,o.prototype.templateChangeHandler=function(b){var c=this;c.templateId=a(b.target).val(),a(c.learningplanSelector).data("templateid",c.templateId),a(c.learningplanSelector).data("scalefilter",""),a(c.learningplanSelector).data("scalesortorder",""),c.resetUserUsingLPTemplateSelection(),c.learningplanId=null,""!==c.templateId?(a(".competencyreport .moreless-actions").removeClass("hidden"),a(".competencyreport .show-toggler").hasClass("hidden")&&a(".competencyreport .advanced").show(),c.loadScalesFromTemplate(c.templateId)):(a(".competencyreport .moreless-actions").addClass("hidden"),a(".competencyreport .advanced").hide(),a(".competencyreport #scale").empty()),c.checkDataFormReady()},o.prototype.loadTags=function(){var b=this;if(b.tagsAreLoading===!1){b.tagsAreLoading=!0,a(b.tagSelector+" option").remove();var f=c.call([{methodname:"report_lpmonitoring_search_tags_for_accessible_plans",args:{}}]);f[0].then(function(c){e.get_string("selecttag","report_lpmonitoring").done(function(d){a(b.tagSelector).append(a("<option>").text(d).val("")),a.each(c,function(c,d){a(b.tagSelector).append(a("<option>").text(d.tag).val(d.id))});var e=a(b.tagSelector+" option[value="+b.tagId+"]").length>0;e===!0?a(b.tagSelector).val(b.tagId):(b.tagId=null,b.tagLearningplanId=null),a(b.tagSelector).change(),b.tagsAreLoading=!1})}).fail(function(a){d.exception(a),b.tagsAreLoading=!1})}},o.prototype.reloadTagsIfNeeded=function(b){b.preventDefault(),a(".competencyreport #tag").is(":checked")&&this.loadTags()},o.prototype.tagChangeHandler=function(b){var f=this;f.tagId=a(b.target).val(),f.withcomments=a("#filter-comments").is(":checked"),""==f.tagId&&(f.tagId=null);var g=c.call([{methodname:"report_lpmonitoring_search_plans_with_tag",args:{tagid:f.tagId,withcomments:f.withcomments}}]);g[0].then(function(b){var c="",d=f.tagLearningplanId;a(f.learningplanTagSelector+" option").remove(),b.length>0?e.get_string("selectlearningplan","report_lpmonitoring").done(function(e){a(f.learningplanTagSelector).append(a("<option>").text(e).val("")),a.each(b,function(b,d){c=d.fullname+" - "+d.planname,a(f.learningplanTagSelector).append(a("<option>").text(c).val(d.planid))}),a(f.learningplanTagSelector).prop("disabled",!1);var g=f.learningplanTagSelector+" option[value="+d+"]",h=a(g).length>0;h===!0?(a(f.learningplanTagSelector).val(d),f.tagLearningplanId=d):f.tagLearningplanId=null}):(a(f.learningplanTagSelector).prop("disabled",!0),e.get_string("nolearningplanavailable","report_lpmonitoring").done(function(b){a(f.learningplanTagSelector).append(a("<option>").text(b).val(""))})),a(f.learningplanTagSelector).trigger("change")}).fail(function(a){d.exception(a)}),f.checkDataFormReady()},o.prototype.learningplanTagChangeHandler=function(b){var c=this;c.tagLearningplanId=a(b.target).val(),c.checkDataFormReady()},o.prototype.changeDisplayRating=function(b){var e=0;a(b.target).is(":checked")&&(e=1);var f=a(b.target).data("displayrating-plan"),g=c.call([{methodname:"tool_lp_set_display_rating_for_plan",args:{planid:f,visible:e}},{methodname:"tool_lp_can_reset_display_rating_for_plan",args:{planid:f}}]);g[0].then(function(){g[1].then(function(b){e?a(".competencyreport .displayratings input[type=checkbox]").prop("checked",!0):a(".competencyreport .displayratings input[type=checkbox]").prop("checked",!1),b&&a(".competencyreport .resetdisplayrating").show()}).fail(function(a){d.exception(a)})}).fail(function(a){d.exception(a)})},o.prototype.resetDisplayRating=function(b){var e=c.call([{methodname:"tool_lp_reset_display_rating_for_plan",args:{planid:b}},{methodname:"tool_lp_has_to_display_rating",args:{planid:b}}]);e[0].then(function(){e[1].then(function(b){b?a(".competencyreport .displayratings input[type=checkbox]").prop("checked",!0):a(".competencyreport .displayratings input[type=checkbox]").prop("checked",!1),a(".competencyreport .resetdisplayrating").hide()}).fail(function(a){d.exception(a)})}).fail(function(a){d.exception(a)})},o.prototype.resetUserUsingLPTemplateSelection=function(){var b=this,c=a(".competencyreport .templatefilter .form-autocomplete-selection"),d=c.find('span[aria-selected="true"]');b.learningplanId=null,d.length&&(d.remove(),a(b.learningplanSelector+" option").remove(),e.get_string("nouserselected","report_lpmonitoring").done(function(b){c.append(a("<span>").text(b))}))},o.prototype.loadScalesFromTemplate=function(e){var f=this,g=c.call([{methodname:"report_lpmonitoring_get_scales_from_template",args:{templateid:parseInt(e)}}]);g[0].then(function(c){var d={};d.scales=c,d.cmcompgradingenabled=f.cmcompgradingEnabled,b.render("report_lpmonitoring/scale_filter",d).done(function(c,d){a(".competencyreport #scale").html(c),b.runTemplateJS(d)}),c.length>0?(a(".competencyreport #scalefilterapply").show(),b.render("report_lpmonitoring/scale_filter_apply",d).done(function(c,d){a(".competencyreport #scalefilter").html(c),b.runTemplateJS(d)}),a(".competencyreport #scalesortorderlabel").show(),b.render("report_lpmonitoring/scale_filter_sortorder",d).done(function(c,d){a(".competencyreport #scalesortorder").html(c),b.runTemplateJS(d)})):(a(".competencyreport #scalefilterapply").hide(),a(".competencyreport #scalesortorderlabel").hide(),a(".competencyreport #scalefilter").html(""),a(".competencyreport #scalesortorder").html(""))}).fail(function(a){d.exception(a)})},o.prototype.buildLearningplanOptions=function(b){var c=this;a(c.scaleSelector+" option").remove(),a(c.scaleSelector).append(a("<option>")),a.each(b,function(b,d){a(c.scaleSelector).append(a("<option>").text(d.name).val(d.id))})},o.prototype.learningplanChangeHandler=function(b){var c=this;c.learningplanId=a(b.target).val(),c.checkDataFormReady()},o.prototype.studentChangeHandler=function(b){var f=this;if(f.userId=a(b.target).val(),null!==f.userId){var g=c.call([{methodname:"core_competency_list_user_plans",args:{userid:f.userId}}]);g[0].then(function(b){a(f.studentPlansSelector+" option").remove(),b.length>0?(a(f.studentPlansSelector).prop("disabled",!1),a.each(b,function(b,c){a(f.studentPlansSelector).append(a("<option>").text(c.name).val(c.id))})):(a(f.studentPlansSelector).prop("disabled",!0),e.get_string("nolearningplanavailable","report_lpmonitoring").done(function(b){a(f.studentPlansSelector).append(a("<option>").text(b).val(""))})),a(f.studentPlansSelector).trigger("change")},d.exception)}f.checkDataFormReady()},o.prototype.studentPlansChangeHandler=function(b){var c=this;c.studentLearningplanId=a(b.target).val(),c.checkDataFormReady()},o.prototype.checkDataFormReady=function(){var b=this,c=!1,d=!1,e=!1;b.userView===!1?(c=a("#template").is(":checked")&&""!==a(b.templateSelector).val(),d=a("#student").is(":checked")&&null!==a(b.studentSelector).val()&&null!==a(b.studentPlansSelector).val()&&""!==a(b.studentPlansSelector).val(),e=a("#tag").is(":checked")&&""!==a(b.tagSelector).val()):d=null!==a(b.studentPlansSelector).val()&&""!==a(b.studentPlansSelector).val(),c||d||e?a("#submitFilterReportButton").removeAttr("disabled"):a("#submitFilterReportButton").attr("disabled","disabled")},o.prototype.loadListCompetencies=function(e,f){var g=this,h=c.call([{methodname:"report_lpmonitoring_list_plan_competencies",args:{id:e.id}}]);h[0].then(function(c){if(c.length>0){var d={competencies_list:c,plan:e,hascompetencies:!0};b.render("report_lpmonitoring/list_competencies",d).done(function(d,h){a("#listPlanCompetencies").html(d),b.runTemplateJS(h),g.loadCompetencyDetail(c,e,f),a("#nav-tabs").removeClass("hidden")})}else f.removeClass("loading"),b.render("report_lpmonitoring/list_competencies",{}).done(function(c,d){a("#listPlanCompetencies").html(c),b.runTemplateJS(d),a("#report-content").empty(),a("#summary-content").empty(),a("#nav-tabs").addClass("hidden")});g.loadSummaryTab(e),g.loadReportTab(e)}).fail(function(a){f.removeClass("loading"),d.exception(a)})},o.prototype.loadCompetencyDetail=function(d,e,f){var g=[],h=this;a.each(d,function(a,b){h.competencies[b.competency.id]={usercompetency:b.usercompetency},g.push({methodname:"report_lpmonitoring_get_competency_detail",args:{competencyid:b.competency.id,userid:e.user.id,planid:e.id}})});var i=c.call(g);a.each(i,function(c,d){d.then(function(d){h.competencies[d.competencyid].competencydetail=d,d.plan=e,d.plan.userid=e.user.id,d.cmcompgradingenabled=h.cmcompgradingEnabled,b.render("report_lpmonitoring/competency_detail",d).done(function(i,j){var k=d.competencyid,l=e.user.id,m=e.id,n=d.scaleid;a("#comp-"+k+" .x_content").html(i),"incoursemodule"===h.compDetailActiveTab?a('.detail-comp-tab a[href="#tab-incms-content-'+d.competencyid+'"]').tab("show"):a('.detail-comp-tab a[href="#tab-incourses-content-'+d.competencyid+'"]').tab("show"),d.cangrade&&h.applyInlineGrader(k,l,m,n),d.hasrating!==!1&&h.ApplyDonutGraph(k,d,!1),d.hasratingincms!==!1&&h.cmcompgradingEnabled&&h.ApplyDonutGraph(k,d,!0),c===g.length-1&&(f.removeClass("loading"),a(".competencyreport .competency-detail a.collapse-link").css("visibility","")),b.runTemplateJS(j),h.colorContrast.apply("#comp-"+k+" .x_content .tile-stats .label.cr-scalename")})})})},o.prototype.loadReportTab=function(e){var f=this,g=c.call([{methodname:"report_lpmonitoring_list_plan_competencies_report",args:{id:e.id}}]);g[0].then(function(c){if(c.competencies_list.length>0){var d={reportinfos:c,plan:e,hascompetencies:!0},g=a("input[type=radio][name=reportfilter]:checked").val();"course"==g?d.filterchecked_course=!0:"module"==g?d.filterchecked_module=!0:d.filterchecked_both=!0,d.tablesearchvalue=a("#table-search-competency").val(),d.tablesearchvaluecolumn=a("#table-search-columns").val(),d.scalefilterreport=a("#scale-filter-report option:selected").val(),b.render("report_lpmonitoring/datatable",d).done(function(c,d){a("#report-content").html(c),b.runTemplateJS(d);var e=new i("[data-region=report-competencies-section]","[data-user-competency=true]");e._refresh=function(){var a=this;f.reloadCompetencyDetail(a._competencyId,a._userId,a._planId),a.close()}})}else{var d={hascompetencies:!1};b.render("report_lpmonitoring/datatable",d).done(function(c,d){a("#report-content").html(c),b.runTemplateJS(d)})}}).fail(function(a){d.exception(a)})},o.prototype.loadSummaryTab=function(e){var f=this,g=c.call([{methodname:"report_lpmonitoring_list_plan_competencies_summary",args:{id:e.id}}]);g[0].then(function(c){if(c.scale_competency.length>0){var d={reportinfos:c,plan:e,hascompetencies:!0},g=a("input[type=radio][name=summaryfilter]:checked").val();"course"==g?d.filterchecked_course=!0:"module"==g?d.filterchecked_module=!0:d.filterchecked_both=!0;for(var h=a("#scale-filter-summary").val(),j=0;j<d.reportinfos.scale_competency.length;j++){var k=d.reportinfos.scale_competency[j].scaleid;d.reportinfos.scale_competency[j].scaleselected=!1,k==h&&(d.reportinfos.scale_competency[j].scaleselected=!0);var l=a("#summary-search-competency-"+k).val();d.reportinfos.scale_competency[j].tablesearchvalue=l}b.render("report_lpmonitoring/summary",d).done(function(c,d){a("#summary-content").html(c),b.runTemplateJS(d);var e=new i("[data-region=summary-competencies-section]","[data-user-competency=true]");e._refresh=function(){var a=this;f.reloadCompetencyDetail(a._competencyId,a._userId,a._planId),a.close()}})}else{var d={hascompetencies:!1};b.render("report_lpmonitoring/summary",d).done(function(c,d){a("#summary-content").html(c),b.runTemplateJS(d)})}}).fail(function(a){d.exception(a)})},o.prototype.applyInlineGrader=function(a,b,c,d){var f=this;e.get_string("chooserating","tool_lp").done(function(e){var g=new j("#rate_"+a,d,a,b,c,"",e);g.on("competencyupdated",function(){f.reloadCompetencyDetail(a,b,c)})})},o.prototype.reloadCompetencyDetail=function(d,e,f){var g=this;g.competencies[d]={};var h=c.call([{methodname:"core_competency_read_plan",args:{id:f}},{methodname:"report_lpmonitoring_get_competency_detail",args:{competencyid:d,userid:e,planid:f}},{methodname:"report_lpmonitoring_read_plan",args:{scalevalues:"",templateid:null,planid:f,scalefilterin:g.scalefilterin,tagid:null,withcomments:!1,withplans:!1}}]);h[0].then(function(c){h[1].then(function(d){g.competencies[d.competencyid].competencydetail=d,d.plan=c,d.cmcompgradingenabled=g.cmcompgradingEnabled,b.render("report_lpmonitoring/competency_detail",d).done(function(c,h){a("#comp-"+d.competencyid+" .x_content").html(c),b.runTemplateJS(h),"incoursemodule"===g.compDetailActiveTab?a('.detail-comp-tab a[href="#tab-incms-content-'+d.competencyid+'"]').tab("show"):a('.detail-comp-tab a[href="#tab-incourses-content-'+d.competencyid+'"]').tab("show"),d.cangrade&&g.applyInlineGrader(d.competencyid,e,f,d.scaleid),d.hasrating!==!1&&g.ApplyDonutGraph(d.competencyid,d,!1),d.hasratingincm!==!1&&g.cmcompgradingEnabled&&g.ApplyDonutGraph(d.competencyid,d,!0),g.colorContrast.apply("#comp-"+d.competencyid+" .x_content .tile-stats .label.cr-scalename")}),b.render("report_lpmonitoring/competency_proficiency",d).done(function(c,e){a("#comp-"+d.competencyid+" span.level").html(c),b.runTemplateJS(e)}),h[2].then(function(c){b.render("report_lpmonitoring/plan_stats_report",{plan:c.plan,hascompetencies:!0}).done(function(c,d){a("#plan-stats-report").html(c),b.runTemplateJS(d)})})})})},o.prototype.ApplyDonutGraph=function(b,c,d){var e={legend:!1,responsive:!1,tooltips:{enabled:!1}},g=[],h="#canvas-graph-"+b;d&&(h="#cm-canvas-graph-"+b);var i=[];a.each(c.scalecompetencyitems,function(a,b){g.push(b.color),d?i.push(b.nbcm):i.push(b.nbcourse)}),new f(a(h),{type:"doughnut",data:{labels:[],datasets:[{data:i,backgroundColor:g,hoverBackgroundColor:[]}]},options:e})},o.prototype.submitFormHandler=function(){var b=this,c=a("#template").is(":checked"),d=a("#tag").is(":checked"),e=null,f=null,g=null;c===!0?(e=b.templateId,f=b.learningplanId,b.withcomments=a("#filter-comment").is(":checked"),b.withplans=a("#filter-plan").is(":checked")):d===!0?(g=b.tagId,f=b.tagLearningplanId):f=b.studentLearningplanId,b.scalesvaluesSelected=a(b.learningplanSelector).data("scalefilter"),"coursemodule"===b.scalefilterin?b.compDetailActiveTab="incoursemodule":b.compDetailActiveTab="incourse",b.displayPlan(f,e,g)},o.prototype.changeScaleHandler=function(){var b=this,c=[];a(".competencyreport .scalefiltervalues").each(function(){a(this).is(":checked")&&c.push({scalevalue:a(this).data("scalevalue"),scaleid:a(this).data("scaleid")})}),c.length>0?(a(".competencyreport input[name=optionscalefilter]").prop("disabled",!1),a(".competencyreport input[name=optionscalesortorder]").prop("disabled",!1),a("#scalefiltercourse").is(":not(:checked)")&&a("#scalefilterplan").is(":not(:checked)")&&(b.cmcompgradingEnabled?a("#scalefiltercoursemodule").prop("checked",!0):a("#scalefiltercourse").prop("checked",!0)),a("#scalesortorderasc").is(":not(:checked)")&&a("#scalesortorderdesc").is(":not(:checked)")&&a("#scalesortorderasc").prop("checked",!0)):(a(".competencyreport input[name=optionscalefilter]").prop("checked",!1),a(".competencyreport input[name=optionscalefilter]").prop("disabled",!0),a(".competencyreport input[name=optionscalesortorder]").prop("disabled",!0),a(".competencyreport input[name=optionscalesortorder]").prop("checked",!1)),b.changeScaleApplyHandler(),b.changeScaleSortorderHandler(),b.resetUserUsingLPTemplateSelection();var d=JSON.stringify(c);a(b.learningplanSelector).data("scalefilter",d)},o.prototype.changeScaleApplyHandler=function(){var b=this;b.scalefilterin="",a("#scalefilterplan").is(":checked")&&(b.scalefilterin=""),a("#scalefiltercourse").is(":checked")&&(b.scalefilterin="course"),a("#scalefiltercoursemodule").is(":checked")&&(b.scalefilterin="coursemodule"),a(b.learningplanSelector).data("scalefilterapply",b.scalefilterin)},o.prototype.changeScaleSortorderHandler=function(){var b=this;b.scalesortorder="ASC",a("#scalesortorderdesc").is(":checked")&&(b.scalesortorder="DESC"),a(b.learningplanSelector).data("scalesortorder",b.scalesortorder)},o.prototype.changeWithcommentsHandler=function(){var b=this;b.withcomments=a("#filter-comment").is(":checked"),a(b.learningplanSelector).data("withcomments",b.withcomments)},o.prototype.changeWithplansHandler=function(){var b=this;b.withplans=a("#filter-plan").is(":checked"),a(b.learningplanSelector).data("withplans",b.withplans)},o.prototype.displayEvidencelist=function(a){var c=this;a.listevidence.length>0&&e.get_string("listofevidence","tool_lp").done(function(e){b.render("report_lpmonitoring/list_evidences_in_competency",a).done(function(b){new h(e,b,function(){m.apply("#listevidencecompetency-"+a.competencyid,!0,!0)},c.destroyDialogue)}).fail(d.exception)})},o.prototype.destroyDialogue=function(a){a.close()},o.prototype.displayCourselist=function(a){var c=this;a.listtotalcourses.length>0&&e.get_string("linkedcourses","tool_lp").done(function(e){b.render("report_lpmonitoring/list_courses_in_competency",a).done(function(b){new h(e,b,function(){m.apply("#listcoursecompetency-"+a.competencyid,!0,!0)},c.destroyDialogue)}).fail(d.exception)})},o.prototype.displayCmlist=function(a){var c=this;a.listtotalcms.length>0&&e.get_string("linkedcms","report_lpmonitoring").done(function(e){b.render("report_lpmonitoring/list_cms_in_competency",a).done(function(b){new h(e,b,function(){m.apply("#listcmcompetency-"+a.competencyid,!0,!0)},c.destroyDialogue)}).fail(d.exception)})},o.prototype.displayPlan=function(f,g,h){var i=null,j=this;i=a(a("#plan-user-info").length?"#plan-user-info":"#reportFilter button"),i.addClass("loading"),a(".competencyreport .competency-detail a.collapse-link").css("visibility","hidden"),j.scalesvaluesSelected=j.userView===!1?j.scalesvaluesSelected:"";var k=c.call([{methodname:"report_lpmonitoring_read_plan",args:{planid:parseInt(f),templateid:parseInt(g),scalevalues:j.scalesvaluesSelected,scalefilterin:j.scalefilterin,scalesortorder:j.scalesortorder,tagid:parseInt(h),withcomments:j.withcomments,withplans:j.withplans}}]);k[0].then(function(c){return c.templateid=parseInt(g),M.cfg.contextid=c.plan.usercontext,c.hasnavigation===!1?a(".plan-info-container").addClass("nonavigation"):a(".plan-info-container").removeClass("nonavigation"),c.navigationclosed=!1,a(".plan-info-container").hasClass("closed")&&(c.navigationclosed=!0),j.userView===!1?b.render("report_lpmonitoring/user_info",c).done(function(d){return a("#userInfoContainer").html(d),j.loadListCompetencies(c.plan,i),b.render("report_lpmonitoring/users_list_navigation",c).done(function(b){a("#users-list-full-navigation").html(b)})}):void e.get_string("learningplancompetencies","report_lpmonitoring",c.plan.name).done(function(b){a("#planInfoContainer h3").text(b),j.loadListCompetencies(c.plan,i)})}).fail(function(c){if(i.removeClass("loading"),"emptytemplate"===c.errorcode){var e={exception:c};return b.render("report_lpmonitoring/user_info",e).done(function(b){a("#userInfoContainer").html(b),a("#listPlanCompetencies").empty(),a("#plan-stats-report").empty(),a("#report-content").empty(),a("#summary-content").empty(),a("#nav-tabs").hide(),a("#users-list-full-navigation").empty()})}d.exception(c)})},o.prototype.displayScaleCourseList=function(a){var c=this;a.scalecompetencyitem.listcourses.length>0&&e.get_string("linkedcourses","tool_lp").done(function(e){b.render("report_lpmonitoring/list_courses_in_scale_value",a).done(function(b){new h(e,b,function(){m.apply("#listscalecoursecompetency-"+a.competencyid,!0,!0)},c.destroyDialogue),c.colorContrast.apply(".moodle-dialogue-base .label.cr-scalename")}).fail(d.exception)})},o.prototype.displayScaleCmList=function(a){var c=this;a.scalecompetencyitem.listcms.length>0&&e.get_string("linkedcms","report_lpmonitoring").done(function(e){b.render("report_lpmonitoring/list_cms_in_scale_value",a).done(function(b){new h(e,b,function(){m.apply("#listscalecmcompetency-"+a.competencyid,!0,!0)},c.destroyDialogue),c.colorContrast.apply(".moodle-dialogue-base .label.cr-scalename")}).fail(d.exception)})},o.prototype.resetGrade=function(a,b,e){var f=this,g=!1;null===e&&(g=!0);var h=new n(g);h.on("rated",function(g,h){var i=c.call([{methodname:"report_lpmonitoring_reset_grading",args:{planid:a,competencyid:e,note:h.note}}]);i[0].then(function(){null===e?f.displayPlan(a,f.templateId,f.tagId):f.reloadCompetencyDetail(e,b,a)}).fail(function(a){d.exception(a)})}),h.display()},o.prototype.initPage=function(){var b=this;e.get_strings([{key:"selectuser",component:"report_lpmonitoring"},{key:"nouserselected",component:"report_lpmonitoring"}]).done(function(c){g.enhance(b.learningplanSelector,!1,"report_lpmonitoring/learningplan",c[0],!1,!0,c[1]),g.enhance(b.studentSelector,!1,"tool_lp/form-user-selector",c[0],!1,!0,c[1]),b.userView===!1&&(a(".competencyreport #student").is(":checked")?(a(".competencyreport .templatefilter").toggleClass("disabled-option",!0),a(".competencyreport .tagfilter").toggleClass("disabled-option",!0)):a(".competencyreport #tag").is(":checked")?(a(".competencyreport .studentfilter").toggleClass("disabled-option",!0),a(".competencyreport .templatefilter").toggleClass("disabled-option",!0)):(a(".competencyreport .studentfilter").toggleClass("disabled-option",!0),a(".competencyreport .tagfilter").toggleClass("disabled-option",!0))),b.checkDataFormReady()}).fail(d.exception),a(".competencyreport").on("click",".moreless-toggler",function(b){b.preventDefault(),a(".advanced").toggle(),a(this).toggleClass("hidden").siblings().removeClass("hidden")}),k.init(),a(".competencyreport").on("click",".collapse-link",function(b){b.preventDefault();var c=a(this).closest(".x_panel"),d=a(this).find("i"),e=c.find(".x_content");d.toggleClass("fa-chevron-right fa-chevron-down"),e.slideToggle(),c.toggleClass("panel-collapsed")}),a(".competencyreport").on("click","a.scaleinfo",function(c){c.preventDefault();var d=a(this).data("competencyid"),e=a(this).data("scalevalue"),f=a(this).data("type");if("undefined"!=typeof b.competencies[d]){var g={},h=b.competencies[d].competencydetail;g.scalecompetencyitem=h.scalecompetencyitems[e-1],g.competencyid=d,"incm"===f?b.displayScaleCmList(g):b.displayScaleCourseList(g)}}),a(".competencyreport #student").on("change",function(){a(this).is(":checked")&&(a(".competencyreport .studentfilter").toggleClass("disabled-option",!1),a(".competencyreport .templatefilter").toggleClass("disabled-option",!0),a(".competencyreport .tagfilter").toggleClass("disabled-option",!0)),b.checkDataFormReady()}),a(".competencyreport #template").on("change",function(){a(this).is(":checked")&&(a(".competencyreport .studentfilter").toggleClass("disabled-option",!0),a(".competencyreport .templatefilter").toggleClass("disabled-option",!1),a(".competencyreport .tagfilter").toggleClass("disabled-option",!0)),b.checkDataFormReady()}),a(".competencyreport #tag").on("change",function(){a(this).is(":checked")&&(b.loadTags(),a(".competencyreport .studentfilter").toggleClass("disabled-option",!0),a(".competencyreport .templatefilter").toggleClass("disabled-option",!0),a(".competencyreport .tagfilter").toggleClass("disabled-option",!1)),b.checkDataFormReady()}),a(document).on("submit","#reportFilter",function(){return b.submitFormHandler(),!1}),a(".competencyreport").on("click","a.navigatetoplan",function(c){c.preventDefault();var d=a(this).data("planid"),e=a(this).data("templateid"),f=a(this).data("tagid");b.displayPlan(d,e,f)}),a(".competencyreport").on("click",".toggle-lp-list-users",function(b){b.preventDefault(),a(this).find("i.angle").toggleClass("fa-angle-double-right fa-angle-double-left"),a(this).closest(".plan-info-container").toggleClass("closed"),a('div[data-region="blocks-lp-list-users"]').toggleClass("lp-list-users-closed")});var c=".plan-info-container .table-list-users .nav-list-users-displayinfo";a(".competencyreport").on("click",c,function(b){b.stopPropagation(),b.preventDefault(),a(this).find("i.fa").toggleClass("fa-angle-down fa-angle-up"),a(this).parent().find("span.item-nav-list-users-info").toggleClass("hidden")}),a(".competencyreport").on("click",".plan-info-container .table-list-users tr",function(c){c.preventDefault();var d=a(this).data("planid"),e=a(this).data("templateid"),f=a(this).data("tagid");b.displayPlan(d,e,f)}),a(".competencyreport").on("click","a.listevidence",function(c){c.preventDefault();var d=a(this).data("competencyid");if("undefined"!=typeof b.competencies[d]){var e={};e.listevidence=b.competencies[d].competencydetail.listevidence,e.competencyid=d,b.displayEvidencelist(e)}}),a(".competencyreport").on("click","a.totalnbcourses",function(c){c.preventDefault();var d=a(this).data("competencyid");if("undefined"!=typeof b.competencies[d]){var e={};e.listtotalcourses=b.competencies[d].competencydetail.listtotalcourses,e.competencyid=d,b.displayCourselist(e)}}),a(".competencyreport").on("click","a.totalnbcms",function(c){c.preventDefault();var d=a(this).data("competencyid");if("undefined"!=typeof b.competencies[d]){var e={};e.listtotalcms=b.competencies[d].competencydetail.listtotalcms,e.competencyid=d,b.displayCmlist(e)}}),a(".competencyreport").on("click",".detail-comp-tab a",function(c){c.preventDefault(),a(c.target).hasClass("incm")?b.compDetailActiveTab="incoursemodule":b.compDetailActiveTab="incourse"}),a(".competencyreport").on("click",".resetdisplayrating a",function(c){c.preventDefault();var d=a(this).data("canresetdisplayrating-plan");b.resetDisplayRating(d)}),a(".competencyreport").on("click",".reset-grade a",function(c){c.preventDefault();var d=a(this).data("resetgrade-plan"),e=a(this).data("competencyid"),f=a(this).data("userid");b.resetGrade(d,f,e)}),a(".competencyreport").on("click",".reset-grade-all a",function(c){c.preventDefault();var d=a(this).data("resetgrade-plan"),e=a(this).data("userid");b.resetGrade(d,e,null)}),e.get_strings([{key:"collapseall"},{key:"expandall"}]).done(function(b){var c=b[0],d=b[1];a(".competencyreport").on("click",".collapsible-actions a",function(b){b.preventDefault(),a(this).hasClass("collapse-all")?(a(this).text(d),a("#listPlanCompetencies div.x_panel:not(.panel-collapsed) a.collapse-link").trigger("click")):(a(this).text(c),a("#listPlanCompetencies div.panel-collapsed a.collapse-link").trigger("click")),a(this).toggleClass("collapse-all expand-all")})}).fail(d.exception)},{init:function(a,b){return new o(a,b)},processResults:function(b,c){var d=[];return a.each(c,function(a,b){d.push({value:b.planid,label:b._label})}),d},transport:function(d,e,f,g){var h,i=a(d).data("scalefilterapply"),j=a(d).data("scalesortorder");j=j?j:"ASC";var k=a(d).data("withcomments");k=!!k&&k;var l=a(d).data("withplans");l=!!l&&l;var m=a(d).data("templateid");return""===m?[]:(h=c.call([{methodname:"report_lpmonitoring_search_users_by_templateid",args:{query:e,templateid:parseInt(m),scalevalues:a(d).data("scalefilter"),scalefilterin:i,scalesortorder:j,withcomments:k,withplans:l}}]),void h[0].then(function(c){var d=[],e=0;return a.each(c,function(c,e){var f=e,g=[];a.each(["idnumber","email","phone1","phone2","department","institution"],function(a,b){"undefined"!=typeof e[b]&&""!==e[b]&&(f.hasidentity=!0,g.push(e[b]))}),f.identity=g.join(", "),d.push(b.render("report_lpmonitoring/form-user-selector-suggestion",f))}),a.when.apply(a.when,d).then(function(){var b=arguments;a.each(c,function(a,c){c._label=b[e],e++}),f(c)})},g))}}});