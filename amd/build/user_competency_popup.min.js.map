{"version":3,"sources":["../src/user_competency_popup.js"],"names":["define","$","notification","str","ajax","templates","ModalFactory","ModalEvents","UserCompetencyPopup","regionSelector","userCompetencySelector","_regionSelector","_userCompetencySelector","_competencyId","_planId","_userId","on","_handleClick","bind","prototype","e","preventDefault","self","cell","target","closest","data","requests","call","methodname","args","competencyid","planid","fail","exception","then","result","_contextLoaded","eventMethodName","plan","iscompleted","userid","context","trigger","get_string","done","title","create","type","types","DEFAULT","body","render","large","modal","popup","getRoot","hidden","focusContentItem","_refresh","show","item","is","focus","find","first","close","destroy"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to enable inline editing of a comptency grade.\n *\n * @module     report_lpmonitoring/user_competency_popup\n * @author     Jean-Philippe Gaudreau <jp.gaudreau@umontreal.ca>\n * @copyright  2016 Université de Montréal\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery',\n        'core/notification',\n        'core/str',\n        'core/ajax',\n        'core/templates',\n        'core/modal_factory',\n        'core/modal_events'],\n    function($, notification, str, ajax, templates, ModalFactory, ModalEvents) {\n\n        /**\n         * UserCompetencyPopup\n         *\n         * @param {String} regionSelector The regionSelector\n         * @param {String} userCompetencySelector The userCompetencySelector\n         */\n        var UserCompetencyPopup = function(regionSelector, userCompetencySelector) {\n            this._regionSelector = regionSelector;\n            this._userCompetencySelector = userCompetencySelector;\n            this._competencyId = null;\n            this._planId = null;\n            this._userId = null;\n\n            $(this._regionSelector).on('click', this._userCompetencySelector, this._handleClick.bind(this));\n        };\n\n        /**\n         * Get the data from the clicked cell and open the popup.\n         *\n         * @method _handleClick\n         * @param {Event} e\n         */\n        UserCompetencyPopup.prototype._handleClick = function(e) {\n            e.preventDefault();\n            var self = this;\n            var cell = $(e.target).closest(this._userCompetencySelector);\n            self._competencyId = $(cell).data('competencyid');\n            self._planId = $(cell).data('planid');\n            self._userId = $(cell).data('userid');\n\n            var requests = ajax.call([{\n                methodname : 'tool_lp_data_for_user_competency_summary_in_plan',\n                args: { competencyid: self._competencyId , planid: self._planId },\n                fail: notification.exception\n            }]);\n\n            // Log the user competency viewed in plan event.\n            requests[0].then(function (result) {\n                self._contextLoaded.bind(self)(result, cell);\n                var eventMethodName = 'core_competency_user_competency_viewed_in_plan';\n                // Trigger core_competency_user_competency_plan_viewed event instead if plan is already completed.\n                if (result.plan.iscompleted) {\n                    eventMethodName = 'core_competency_user_competency_plan_viewed';\n                }\n                ajax.call([{\n                    methodname: eventMethodName,\n                    args: {competencyid: self._competencyId, userid: self._userId, planid: self._planId},\n                    fail: notification.exception\n                }]);\n            });\n        };\n\n        /**\n         * We loaded the context, now render the template.\n         *\n         * @method _contextLoaded\n         * @param {Object} context\n         * @param {Object} trigger\n         */\n        UserCompetencyPopup.prototype._contextLoaded = function(context, trigger) {\n            var self = this;\n            return str.get_string('usercompetencysummary', 'report_competency').done(function(title) {\n                return ModalFactory.create({\n                    type: ModalFactory.types.DEFAULT,\n                    title: title,\n                    body: templates.render('tool_lp/user_competency_summary_in_plan', context),\n                    large: true\n                }, trigger).done(function(modal) {\n                    // Keep a reference to the modal.\n                    self.popup = modal;\n                    self.popup.getRoot().on(ModalEvents.hidden, function() {\n                        self.focusContentItem(trigger);\n                        self._refresh();\n                    });\n                    self.popup.show();\n                }.bind(this));\n            }).fail(notification.exception);\n        };\n\n        /**\n         * Focus the given content item or the first focusable element within\n         * the content item.\n         *\n         * @method focusContentItem\n         * @param {object} item The content item jQuery element\n         */\n        UserCompetencyPopup.prototype.focusContentItem = function(item) {\n            var focusable = 'input:not([type=\"hidden\"]), a[href], button, textarea, select, [tabindex]';\n            if (item.is(focusable)) {\n                item.focus();\n            } else {\n                item.find(focusable).first().focus();\n            }\n        };\n\n        /**\n         * @var {Dialogue} popup  The popup window (Dialogue).\n         * @private\n         */\n        UserCompetencyPopup.prototype.popup = null;\n\n        /**\n         * Destroy DOM after close.\n         *\n         * @method close\n         */\n        UserCompetencyPopup.prototype.close = function() {\n            this.popup.destroy();\n            this.popup = null;\n        };\n\n        /**\n         * Refresh the page.\n         *\n         * @method _refresh\n         */\n        UserCompetencyPopup.prototype._refresh = function() {};\n\n        return  UserCompetencyPopup;\n    });"],"file":"user_competency_popup.min.js"}